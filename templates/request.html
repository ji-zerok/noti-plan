<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>캠페인 신청</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>광고성 알림 물량 관리</h1>
            <ul class="nav-menu">
                <li><a href="/admin">관리자</a></li>
                <li><a href="/request" class="active">캠페인신청</a></li>
                <li><a href="/calendar">현황보기</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h2>캠페인 신청</h2>

        <div class="info-box">
            <h3>📌 안내사항</h3>
            <ul>
                <li>조직별로 설정된 월간 총 물량을 초과할 수 없습니다.</li>
                <li>신청한 물량은 즉시 반영되며, 현황보기에서 확인할 수 있습니다.</li>
                <li>물량 초과 시 신청이 거부됩니다.</li>
                <li><strong>물량 입력 범위: 최소 100건 ~ 최대 1,000만건</strong></li>
                <li>입력 예시: <code>1천</code>, <code>5만</code>, <code>12만</code>, <code>35만</code></li>
            </ul>
        </div>

        <div class="form-card">
            <form id="requestForm">
                <div class="form-group">
                    <label for="organization">조직</label>
                    <select id="organization" required>
                        <option value="">조직 선택</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}">{{ org.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="service">서비스</label>
                    <select id="service" required disabled>
                        <option value="">먼저 조직을 선택하세요</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="channel">발송 채널</label>
                    <select id="channel" required>
                        <option value="naver">네이버앱</option>
                        <option value="payco">페이앱</option>
                        <option value="talktalk">톡톡</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sendDate">발송 날짜</label>
                    <input type="date" id="sendDate" required>
                </div>

                <div class="form-group">
                    <label for="sendTime">발송 시간</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: nowrap;">
                        <label style="display: flex; align-items: center; gap: 0.3rem; white-space: nowrap;">
                            <input type="radio" name="ampm" value="AM" checked>
                            <span>오전</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; white-space: nowrap;">
                            <input type="radio" name="ampm" value="PM">
                            <span>오후</span>
                        </label>
                        <select id="sendHour" style="width: auto;">
                            <option value="">시</option>
                            <option value="09">09</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="01">01</option>
                            <option value="02">02</option>
                            <option value="03">03</option>
                            <option value="04">04</option>
                            <option value="05">05</option>
                            <option value="06">06</option>
                            <option value="07">07</option>
                            <option value="08">08</option>
                        </select>
                        <span>시</span>
                        <select id="sendMinute" style="width: auto;">
                            <option value="">분</option>
                            <option value="00">00</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="30">30</option>
                            <option value="40">40</option>
                            <option value="50">50</option>
                        </select>
                        <span>분</span>
                    </div>
                    <small class="help-text">선택사항</small>
                </div>

                <div class="form-group">
                    <label for="campaignName">캠페인명</label>
                    <input type="text" id="campaignName" placeholder="예: 신용대출 프로모션">
                    <small class="help-text">선택사항</small>
                </div>

                <div class="form-group">
                    <label for="quantity">발송 물량</label>
                    <input type="text" id="quantityDisplay" placeholder="예: 35만" required>
                    <input type="hidden" id="quantity">
                    <div class="quantity-display">
                        <span id="quantityRealValue">0건</span>
                    </div>
                    <small class="help-text">예시: 1천(1,000) / 5만(50,000) / 35만(350,000)</small>
                </div>

                <div id="quotaInfo" class="quota-info" style="display: none;">
                    <div class="quota-detail">
                        <span>조직 총 물량:</span>
                        <strong id="totalQuota">-</strong>
                    </div>
                    <div class="quota-detail">
                        <span>신청된 물량:</span>
                        <strong id="requestedQuota">-</strong>
                    </div>
                    <div class="quota-detail">
                        <span>남은 물량:</span>
                        <strong id="remainingQuota" class="remaining">-</strong>
                    </div>
                    <div class="quota-detail" style="border-top: 2px solid #3498db; padding-top: 1rem; margin-top: 0.5rem;">
                        <span style="font-size: 1.1rem;">✅ 신청 가능 물량:</span>
                        <strong id="availableQuota" style="font-size: 1.3rem; color: #27ae60;">-</strong>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">신청하기</button>
            </form>
        </div>

        <h2 style="margin-top: 3rem;">신청된 캠페인 목록</h2>
        <div class="form-card">
            <div class="form-group">
                <label for="requestListService">서비스 선택</label>
                <select id="requestListService">
                    <option value="">서비스를 선택하세요</option>
                </select>
            </div>
            <div id="requestListContainer">
                <p class="text-muted">서비스를 선택하면 신청 목록을 확인할 수 있습니다.</p>
            </div>
        </div>
    </div>

    <script>
        const orgSelect = document.getElementById('organization');
        const serviceSelect = document.getElementById('service');
        const channelSelect = document.getElementById('channel');
        const sendDateInput = document.getElementById('sendDate');
        const sendHourInput = document.getElementById('sendHour');
        const sendMinuteInput = document.getElementById('sendMinute');
        const campaignNameInput = document.getElementById('campaignName');
        const form = document.getElementById('requestForm');
        const quotaInfo = document.getElementById('quotaInfo');
        const quantityDisplayInput = document.getElementById('quantityDisplay');
        const quantityHiddenInput = document.getElementById('quantity');
        const quantityRealValue = document.getElementById('quantityRealValue');
        const requestListServiceSelect = document.getElementById('requestListService');
        const requestListContainer = document.getElementById('requestListContainer');

        // 기본 날짜 설정 (오늘)
        const today = new Date();
        sendDateInput.value = today.toISOString().split('T')[0];
        sendDateInput.min = today.toISOString().split('T')[0];

        // 물량 입력 변환 함수
        function parseKoreanNumber(input) {
            if (!input) return 0;

            // 쉼표 제거
            input = input.replace(/,/g, '');

            // 숫자만 있는 경우
            if (/^\d+$/.test(input)) {
                return parseInt(input);
            }

            // 한글 단위 처리
            let result = 0;

            // 만 단위 처리
            const manMatch = input.match(/(\d+(?:\.\d+)?)\s*만/);
            if (manMatch) {
                result += parseFloat(manMatch[1]) * 10000;
            }

            // 천 단위 처리
            const cheonMatch = input.match(/(\d+(?:\.\d+)?)\s*천/);
            if (cheonMatch) {
                result += parseFloat(cheonMatch[1]) * 1000;
            }

            // 백 단위 처리
            const baekMatch = input.match(/(\d+(?:\.\d+)?)\s*백/);
            if (baekMatch) {
                result += parseFloat(baekMatch[1]) * 100;
            }

            return Math.floor(result);
        }

        // 실시간 변환 표시
        quantityDisplayInput.addEventListener('input', () => {
            const value = parseKoreanNumber(quantityDisplayInput.value);
            quantityHiddenInput.value = value;
            quantityRealValue.textContent = value.toLocaleString() + '건';
        });

        // 조직 선택 시 서비스 목록 로드
        orgSelect.addEventListener('change', async () => {
            serviceSelect.innerHTML = '<option value="">서비스 선택</option>';
            serviceSelect.disabled = true;
            quotaInfo.style.display = 'none';

            if (!orgSelect.value) return;

            try {
                const response = await fetch(`/api/services/${orgSelect.value}`);
                const services = await response.json();

                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.name} (${service.manager_name})`;
                    serviceSelect.appendChild(option);
                });

                serviceSelect.disabled = false;
            } catch (error) {
                alert('서비스 목록을 불러오는데 실패했습니다.');
                console.error(error);
            }
        });

        // 전체 서비스 목록 로드 (신청 목록용)
        async function loadAllServices() {
            try {
                const response = await fetch('/api/services');
                const services = await response.json();

                requestListServiceSelect.innerHTML = '<option value="">서비스를 선택하세요</option>';
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.organization_name} - ${service.name}`;
                    requestListServiceSelect.appendChild(option);
                });
            } catch (error) {
                console.error('서비스 목록 로드 실패:', error);
            }
        }

        // 페이지 로드 시 서비스 목록 로드
        loadAllServices();

        // 날짜 변경 시 물량 정보 로드
        async function loadQuotaInfo() {
            if (!orgSelect.value || !sendDateInput.value) return;

            const date = new Date(sendDateInput.value);
            const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const channel = channelSelect.value;

            try {
                const response = await fetch(`/api/calendar/${orgSelect.value}/${yearMonth}?channel=${channel}`);
                const data = await response.json();

                document.getElementById('totalQuota').textContent = data.total_quota.toLocaleString() + '건';
                document.getElementById('requestedQuota').textContent = data.total_requested.toLocaleString() + '건';

                const remaining = data.remaining;
                const remainingEl = document.getElementById('remainingQuota');
                remainingEl.textContent = remaining.toLocaleString() + '건';

                // 신청 가능 물량 표시
                const availableEl = document.getElementById('availableQuota');
                availableEl.textContent = remaining.toLocaleString() + '건';

                if (remaining <= 0) {
                    remainingEl.className = 'remaining exceeded';
                    availableEl.style.color = '#e74c3c';
                } else if (remaining < data.total_quota * 0.2) {
                    remainingEl.className = 'remaining warning';
                    availableEl.style.color = '#f39c12';
                } else {
                    remainingEl.className = 'remaining';
                    availableEl.style.color = '#27ae60';
                }

                quotaInfo.style.display = 'block';
            } catch (error) {
                console.error('물량 정보 조회 실패:', error);
            }
        }

        sendDateInput.addEventListener('change', loadQuotaInfo);
        orgSelect.addEventListener('change', loadQuotaInfo);
        channelSelect.addEventListener('change', loadQuotaInfo);

        // 폼 제출
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const quantity = parseInt(quantityHiddenInput.value);

            if (quantity < 100 || quantity > 10000000) {
                alert('물량은 100건 이상 1,000만건 이하로 입력해주세요.');
                return;
            }

            // 오전/오후 처리
            let finalTime = null;
            if (sendHourInput.value && sendMinuteInput.value) {
                const ampm = document.querySelector('input[name="ampm"]:checked').value;
                const hour = sendHourInput.value;
                const minute = sendMinuteInput.value;

                let finalHour = hour;
                if (ampm === 'PM' && hour !== '12') {
                    // 오후 시간 변환 (12시 제외)
                    finalHour = String(parseInt(hour) + 12).padStart(2, '0');
                } else if (ampm === 'AM' && hour === '12') {
                    // 오전 12시는 00시로 변환
                    finalHour = '00';
                }

                finalTime = `${finalHour}:${minute}`;
            }

            const data = {
                service_id: parseInt(serviceSelect.value),
                send_date: sendDateInput.value,
                send_time: finalTime,
                channel: channelSelect.value,
                campaign_name: campaignNameInput.value || null,
                quantity: quantity
            };

            try {
                const response = await fetch('/api/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    quantityDisplayInput.value = '';
                    quantityHiddenInput.value = '';
                    quantityRealValue.textContent = '0건';
                    sendHourInput.value = '';
                    sendMinuteInput.value = '';
                    campaignNameInput.value = '';

                    // 물량 정보 새로고침
                    loadQuotaInfo();

                    // 신청 목록 새로고침 (현재 선택된 서비스가 있으면)
                    if (requestListServiceSelect.value === serviceSelect.value) {
                        loadRequestList();
                    }
                } else {
                    alert('신청 실패: ' + result.message);
                }
            } catch (error) {
                alert('물량 신청 중 오류가 발생했습니다.');
                console.error(error);
            }
        });

        // 신청 목록 로드
        requestListServiceSelect.addEventListener('change', loadRequestList);

        async function loadRequestList() {
            const serviceId = requestListServiceSelect.value;

            if (!serviceId) {
                requestListContainer.innerHTML = '<p class="text-muted">서비스를 선택하면 신청 목록을 확인할 수 있습니다.</p>';
                return;
            }

            try {
                const response = await fetch(`/api/requests/${serviceId}`);
                const requests = await response.json();

                if (requests.length === 0) {
                    requestListContainer.innerHTML = '<p class="text-muted">신청된 캠페인이 없습니다.</p>';
                    return;
                }

                let html = '<table class="quota-table"><thead><tr>';
                html += '<th>발송일시</th><th>채널</th><th>캠페인명</th><th>물량</th><th>등록일시</th><th>작업</th>';
                html += '</tr></thead><tbody>';

                requests.forEach(req => {
                    html += '<tr>';
                    const dateTime = req.send_time !== '-' ? `${req.send_date} ${req.send_time}` : req.send_date;
                    html += `<td>${dateTime}</td>`;
                    html += `<td><span class="channel-badge channel-${req.channel}">${req.channel_name}</span></td>`;
                    html += `<td>${req.campaign_name}</td>`;
                    html += `<td class="quota-value">${req.quantity.toLocaleString()}건</td>`;
                    html += `<td>${req.created_at}</td>`;
                    html += `<td><button class="btn-delete" onclick="deleteRequest(${req.id})">삭제</button></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                requestListContainer.innerHTML = html;
            } catch (error) {
                console.error('신청 목록 로드 실패:', error);
                requestListContainer.innerHTML = '<p class="text-muted">신청 목록을 불러오는데 실패했습니다.</p>';
            }
        }

        // 신청 삭제
        window.deleteRequest = async function(requestId) {
            if (!confirm('정말 삭제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`/api/request/${requestId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadRequestList();
                    loadQuotaInfo();
                } else {
                    alert('삭제 실패: ' + result.message);
                }
            } catch (error) {
                alert('삭제 중 오류가 발생했습니다.');
                console.error(error);
            }
        };
    </script>
</body>
</html>