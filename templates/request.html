<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìº í˜ì¸ ì‹ ì²­</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>ê´‘ê³ ì„± ì•Œë¦¼ ë¬¼ëŸ‰ ê´€ë¦¬</h1>
            <ul class="nav-menu">
                <li><a href="/admin">ê´€ë¦¬ì</a></li>
                <li><a href="/request" class="active">ìº í˜ì¸ì‹ ì²­</a></li>
                <li><a href="/calendar">í˜„í™©ë³´ê¸°</a></li>
            </ul>
        </div>
    </nav>

    <div class="request-container">
        <h2>ìº í˜ì¸ ì‹ ì²­</h2>

        <div class="info-box">
            <h3>ğŸ“Œ ì•ˆë‚´ì‚¬í•­</h3>
            <ul>
                <li>ì¡°ì§ë³„ë¡œ ì„¤ì •ëœ ì›”ê°„ ì´ ë¬¼ëŸ‰ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
                <li>ì‹ ì²­í•œ ë¬¼ëŸ‰ì€ ì¦‰ì‹œ ë°˜ì˜ë˜ë©°, í˜„í™©ë³´ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li>ë¬¼ëŸ‰ ì´ˆê³¼ ì‹œ ì‹ ì²­ì´ ê±°ë¶€ë©ë‹ˆë‹¤.</li>
                <li><strong>ë¬¼ëŸ‰ ì…ë ¥ ë²”ìœ„: ìµœì†Œ 100ê±´ ~ ìµœëŒ€ 1,000ë§Œê±´</strong></li>
                <li>ì…ë ¥ ì˜ˆì‹œ: <code>1ì²œ</code>, <code>5ë§Œ</code>, <code>12ë§Œ</code>, <code>35ë§Œ</code></li>
            </ul>
        </div>

        <div class="two-column-layout">
            <!-- ì™¼ìª½: ì‹ ì²­ í¼ -->
            <div class="request-form-section">
                <div class="form-card">
                    <form id="requestForm">
                        <!-- ì¡°ì§-ì„œë¹„ìŠ¤ í•œ ì¤„ -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label for="organization" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #34495e;">ì¡°ì§</label>
                                <select id="organization" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                                    <option value="">ì¡°ì§ ì„ íƒ</option>
                                    {% for org in organizations %}
                                    <option value="{{ org.id }}">{{ org.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="service" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #34495e;">ì„œë¹„ìŠ¤</label>
                                <select id="service" required disabled style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                                    <option value="">ë¨¼ì € ì¡°ì§ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="channel">ë°œì†¡ ì±„ë„</label>
                            <select id="channel" required>
                                <option value="naver">ë„¤ì´ë²„ì•±</option>
                                <option value="payco">í˜ì´ì•±</option>
                                <option value="talktalk">í†¡í†¡</option>
                            </select>
                        </div>

                        <!-- ë°œì†¡ ë‚ ì§œ-ì‹œê°„ í•œ ì¤„ -->
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label for="sendDate" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #34495e;">ë°œì†¡ ë‚ ì§œ</label>
                                <input type="date" id="sendDate" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            </div>
                            <div>
                                <label for="sendTime" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #34495e;">ë°œì†¡ ì‹œê°„</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: nowrap;">
                                    <label style="display: flex; align-items: center; gap: 0.3rem; white-space: nowrap;">
                                        <input type="radio" name="ampm" value="AM" checked>
                                        <span>ì˜¤ì „</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.3rem; white-space: nowrap;">
                                        <input type="radio" name="ampm" value="PM">
                                        <span>ì˜¤í›„</span>
                                    </label>
                                    <select id="sendHour" required style="width: auto; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">ì‹œ</option>
                                        <option value="09">09</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="01">01</option>
                                        <option value="02">02</option>
                                        <option value="03">03</option>
                                        <option value="04">04</option>
                                        <option value="05">05</option>
                                        <option value="06">06</option>
                                        <option value="07">07</option>
                                        <option value="08">08</option>
                                    </select>
                                    <span>ì‹œ</span>
                                    <select id="sendMinute" required style="width: auto; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">ë¶„</option>
                                        <option value="00">00</option>
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="30">30</option>
                                        <option value="40">40</option>
                                        <option value="50">50</option>
                                    </select>
                                    <span>ë¶„</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="campaignName">ìº í˜ì¸ëª…</label>
                            <input type="text" id="campaignName" placeholder="ì˜ˆ: ì‹ ìš©ëŒ€ì¶œ í”„ë¡œëª¨ì…˜" required>
                        </div>

                        <div class="form-group">
                            <label for="quantity">ë°œì†¡ ë¬¼ëŸ‰</label>
                            <input type="text" id="quantityDisplay" placeholder="ì˜ˆ: 35ë§Œ" required>
                            <input type="hidden" id="quantity">
                            <div class="quantity-display">
                                <span id="quantityRealValue">0ê±´</span>
                            </div>
                        </div>

                        <div id="quotaInfo" class="quota-info" style="display: none;">
                            <div class="quota-detail">
                                <span>ì¡°ì§ ì´ ë¬¼ëŸ‰:</span>
                                <strong id="totalQuota">-</strong>
                            </div>
                            <div class="quota-detail">
                                <span>ì‹ ì²­ëœ ë¬¼ëŸ‰:</span>
                                <strong id="requestedQuota">-</strong>
                            </div>
                            <div class="quota-detail">
                                <span>ë‚¨ì€ ë¬¼ëŸ‰:</span>
                                <strong id="remainingQuota" class="remaining">-</strong>
                            </div>
                            <div class="quota-detail" style="border-top: 2px solid #3498db; padding-top: 1rem; margin-top: 0.5rem;">
                                <span style="font-size: 1.1rem;">âœ… ì‹ ì²­ ê°€ëŠ¥ ë¬¼ëŸ‰:</span>
                                <strong id="availableQuota" style="font-size: 1.3rem; color: #27ae60;">-</strong>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">ì‹ ì²­í•˜ê¸°</button>
                    </form>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ìº í˜ì¸ ëª©ë¡ -->
            <div class="request-list-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">ì‹ ì²­ëœ ìº í˜ì¸ ëª©ë¡</h3>
                    <button id="downloadExcel" class="btn btn-primary" style="display: none; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        ğŸ“¥ Excel ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
                <div class="form-card">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="viewType">ì¡°íšŒ ë²”ìœ„</label>
                            <select id="viewType">
                                <option value="all">ì „ì²´</option>
                                <option value="org">ì¡°ì§ë³„</option>
                                <option value="service">ì„œë¹„ìŠ¤ë³„</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="requestListOrg">ì¡°ì§ ì„ íƒ</label>
                            <select id="requestListOrg" disabled>
                                <option value="">ì¡°ì§ ì„ íƒ</option>
                                {% for org in organizations %}
                                <option value="{{ org.id }}">{{ org.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="requestListService">ì„œë¹„ìŠ¤ ì„ íƒ</label>
                            <select id="requestListService" disabled>
                                <option value="">ì„œë¹„ìŠ¤ ì„ íƒ</option>
                            </select>
                        </div>
                    </div>
                    <div id="requestListContainer">
                        <p class="text-muted">ì¡°íšŒ ë²”ìœ„ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const orgSelect = document.getElementById('organization');
        const serviceSelect = document.getElementById('service');
        const channelSelect = document.getElementById('channel');
        const sendDateInput = document.getElementById('sendDate');
        const sendHourInput = document.getElementById('sendHour');
        const sendMinuteInput = document.getElementById('sendMinute');
        const campaignNameInput = document.getElementById('campaignName');
        const form = document.getElementById('requestForm');
        const quotaInfo = document.getElementById('quotaInfo');
        const quantityDisplayInput = document.getElementById('quantityDisplay');
        const quantityHiddenInput = document.getElementById('quantity');
        const quantityRealValue = document.getElementById('quantityRealValue');
        const requestListServiceSelect = document.getElementById('requestListService');
        const requestListContainer = document.getElementById('requestListContainer');

        // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ì˜¤ëŠ˜)
        const today = new Date();
        sendDateInput.value = today.toISOString().split('T')[0];
        sendDateInput.min = today.toISOString().split('T')[0];

        // ë¬¼ëŸ‰ ì…ë ¥ ë³€í™˜ í•¨ìˆ˜
        function parseKoreanNumber(input) {
            if (!input) return 0;

            // ì‰¼í‘œ ì œê±°
            input = input.replace(/,/g, '');

            // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš°
            if (/^\d+$/.test(input)) {
                return parseInt(input);
            }

            // í•œê¸€ ë‹¨ìœ„ ì²˜ë¦¬
            let result = 0;

            // ë§Œ ë‹¨ìœ„ ì²˜ë¦¬
            const manMatch = input.match(/(\d+(?:\.\d+)?)\s*ë§Œ/);
            if (manMatch) {
                result += parseFloat(manMatch[1]) * 10000;
            }

            // ì²œ ë‹¨ìœ„ ì²˜ë¦¬
            const cheonMatch = input.match(/(\d+(?:\.\d+)?)\s*ì²œ/);
            if (cheonMatch) {
                result += parseFloat(cheonMatch[1]) * 1000;
            }

            // ë°± ë‹¨ìœ„ ì²˜ë¦¬
            const baekMatch = input.match(/(\d+(?:\.\d+)?)\s*ë°±/);
            if (baekMatch) {
                result += parseFloat(baekMatch[1]) * 100;
            }

            return Math.floor(result);
        }

        // ì‹¤ì‹œê°„ ë³€í™˜ í‘œì‹œ
        quantityDisplayInput.addEventListener('input', () => {
            const value = parseKoreanNumber(quantityDisplayInput.value);
            quantityHiddenInput.value = value;
            quantityRealValue.textContent = value.toLocaleString() + 'ê±´';
        });

        // ì¡°ì§ ì„ íƒ ì‹œ ì„œë¹„ìŠ¤ ëª©ë¡ ë¡œë“œ
        orgSelect.addEventListener('change', async () => {
            serviceSelect.innerHTML = '<option value="">ì„œë¹„ìŠ¤ ì„ íƒ</option>';
            serviceSelect.disabled = true;
            quotaInfo.style.display = 'none';

            if (!orgSelect.value) return;

            try {
                const response = await fetch(`/api/services/${orgSelect.value}`);
                const services = await response.json();

                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.name} (${service.manager_name})`;
                    serviceSelect.appendChild(option);
                });

                serviceSelect.disabled = false;
            } catch (error) {
                alert('ì„œë¹„ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        });

        // ì „ì²´ ì„œë¹„ìŠ¤ ëª©ë¡ ë¡œë“œ (ì‹ ì²­ ëª©ë¡ìš©)
        async function loadAllServices() {
            try {
                const response = await fetch('/api/services');
                const services = await response.json();

                requestListServiceSelect.innerHTML = '<option value="">ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.organization_name} - ${service.name}`;
                    requestListServiceSelect.appendChild(option);
                });
            } catch (error) {
                console.error('ì„œë¹„ìŠ¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë¹„ìŠ¤ ëª©ë¡ ë¡œë“œ
        loadAllServices();

        // ë‚ ì§œ ë³€ê²½ ì‹œ ë¬¼ëŸ‰ ì •ë³´ ë¡œë“œ
        async function loadQuotaInfo() {
            if (!orgSelect.value || !sendDateInput.value) return;

            const date = new Date(sendDateInput.value);
            const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const channel = channelSelect.value;

            try {
                const response = await fetch(`/api/calendar/${orgSelect.value}/${yearMonth}?channel=${channel}`);
                const data = await response.json();

                document.getElementById('totalQuota').textContent = data.total_quota.toLocaleString() + 'ê±´';
                document.getElementById('requestedQuota').textContent = data.total_requested.toLocaleString() + 'ê±´';

                const remaining = data.remaining;
                const remainingEl = document.getElementById('remainingQuota');
                remainingEl.textContent = remaining.toLocaleString() + 'ê±´';

                // ì‹ ì²­ ê°€ëŠ¥ ë¬¼ëŸ‰ í‘œì‹œ
                const availableEl = document.getElementById('availableQuota');
                availableEl.textContent = remaining.toLocaleString() + 'ê±´';

                if (remaining <= 0) {
                    remainingEl.className = 'remaining exceeded';
                    availableEl.style.color = '#e74c3c';
                } else if (remaining < data.total_quota * 0.2) {
                    remainingEl.className = 'remaining warning';
                    availableEl.style.color = '#f39c12';
                } else {
                    remainingEl.className = 'remaining';
                    availableEl.style.color = '#27ae60';
                }

                quotaInfo.style.display = 'block';
            } catch (error) {
                console.error('ë¬¼ëŸ‰ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        sendDateInput.addEventListener('change', loadQuotaInfo);
        orgSelect.addEventListener('change', loadQuotaInfo);
        channelSelect.addEventListener('change', loadQuotaInfo);

        // í¼ ì œì¶œ
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const quantity = parseInt(quantityHiddenInput.value);

            if (quantity < 100 || quantity > 10000000) {
                alert('ë¬¼ëŸ‰ì€ 100ê±´ ì´ìƒ 1,000ë§Œê±´ ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì˜¤ì „/ì˜¤í›„ ì²˜ë¦¬
            let finalTime = null;
            if (sendHourInput.value && sendMinuteInput.value) {
                const ampm = document.querySelector('input[name="ampm"]:checked').value;
                const hour = sendHourInput.value;
                const minute = sendMinuteInput.value;

                let finalHour = hour;
                if (ampm === 'PM' && hour !== '12') {
                    // ì˜¤í›„ ì‹œê°„ ë³€í™˜ (12ì‹œ ì œì™¸)
                    finalHour = String(parseInt(hour) + 12).padStart(2, '0');
                } else if (ampm === 'AM' && hour === '12') {
                    // ì˜¤ì „ 12ì‹œëŠ” 00ì‹œë¡œ ë³€í™˜
                    finalHour = '00';
                }

                finalTime = `${finalHour}:${minute}`;

                // ì‹œê°„ ë²”ìœ„ ê²€ì¦ (ì˜¤ì „ 9ì‹œ ~ ì˜¤í›„ 8ì‹œ)
                const hourInt = parseInt(finalHour);
                if (hourInt < 9 || hourInt > 20) {
                    alert('ë°œì†¡ ì‹œê°„ì€ ì˜¤ì „ 9ì‹œë¶€í„° ì˜¤í›„ 8ì‹œ ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                    return;
                }
            }

            const data = {
                service_id: parseInt(serviceSelect.value),
                send_date: sendDateInput.value,
                send_time: finalTime,
                channel: channelSelect.value,
                campaign_name: campaignNameInput.value || null,
                quantity: quantity
            };

            try {
                const response = await fetch('/api/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    quantityDisplayInput.value = '';
                    quantityHiddenInput.value = '';
                    quantityRealValue.textContent = '0ê±´';
                    sendHourInput.value = '';
                    sendMinuteInput.value = '';
                    campaignNameInput.value = '';

                    // ë¬¼ëŸ‰ ì •ë³´ ìƒˆë¡œê³ ì¹¨
                    loadQuotaInfo();

                    // ì‹ ì²­ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (í˜„ì¬ ì„ íƒëœ ì„œë¹„ìŠ¤ê°€ ìˆìœ¼ë©´)
                    if (requestListServiceSelect.value === serviceSelect.value) {
                        loadRequestList();
                    }
                } else {
                    alert('ì‹ ì²­ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                alert('ë¬¼ëŸ‰ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        });

        // ì‹ ì²­ ëª©ë¡ ë¡œë“œ
        const downloadExcelBtn = document.getElementById('downloadExcel');
        const viewTypeSelect = document.getElementById('viewType');
        const requestListOrgSelect = document.getElementById('requestListOrg');
        let currentRequests = []; // í˜„ì¬ ë¡œë“œëœ ìš”ì²­ ë°ì´í„° ì €ì¥
        let currentViewType = 'all'; // í˜„ì¬ ì¡°íšŒ íƒ€ì…
        let currentViewName = 'ì „ì²´'; // í˜„ì¬ ì¡°íšŒ ì´ë¦„ (Excel íŒŒì¼ëª…ìš©)

        // ì¡°íšŒ ë²”ìœ„ ë³€ê²½ ì‹œ
        viewTypeSelect.addEventListener('change', () => {
            const viewType = viewTypeSelect.value;

            if (viewType === 'all') {
                requestListOrgSelect.disabled = true;
                requestListOrgSelect.value = '';
                requestListServiceSelect.disabled = true;
                requestListServiceSelect.value = '';
                requestListServiceSelect.innerHTML = '<option value="">ì„œë¹„ìŠ¤ ì„ íƒ</option>';
                loadRequestList();
            } else if (viewType === 'org') {
                requestListOrgSelect.disabled = false;
                requestListOrgSelect.value = '';
                requestListServiceSelect.disabled = true;
                requestListServiceSelect.value = '';
                requestListServiceSelect.innerHTML = '<option value="">ì„œë¹„ìŠ¤ ì„ íƒ</option>';
                requestListContainer.innerHTML = '<p class="text-muted">ì¡°ì§ì„ ì„ íƒí•˜ì„¸ìš”.</p>';
                downloadExcelBtn.style.display = 'none';
            } else if (viewType === 'service') {
                requestListOrgSelect.disabled = false;
                requestListOrgSelect.value = '';
                requestListServiceSelect.disabled = true;
                requestListServiceSelect.value = '';
                requestListServiceSelect.innerHTML = '<option value="">ë¨¼ì € ì¡°ì§ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                requestListContainer.innerHTML = '<p class="text-muted">ì¡°ì§ê³¼ ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>';
                downloadExcelBtn.style.display = 'none';
            }
        });

        // ì¡°ì§ ì„ íƒ ë³€ê²½ ì‹œ
        requestListOrgSelect.addEventListener('change', async () => {
            const viewType = viewTypeSelect.value;
            const orgId = requestListOrgSelect.value;

            if (!orgId) {
                requestListServiceSelect.disabled = true;
                requestListServiceSelect.value = '';
                requestListServiceSelect.innerHTML = '<option value="">ì„œë¹„ìŠ¤ ì„ íƒ</option>';
                requestListContainer.innerHTML = '<p class="text-muted">ì¡°ì§ì„ ì„ íƒí•˜ì„¸ìš”.</p>';
                downloadExcelBtn.style.display = 'none';
                return;
            }

            if (viewType === 'org') {
                loadRequestList();
            } else if (viewType === 'service') {
                // ì„œë¹„ìŠ¤ ëª©ë¡ ë¡œë“œ
                try {
                    const response = await fetch(`/api/services/${orgId}`);
                    const services = await response.json();

                    requestListServiceSelect.innerHTML = '<option value="">ì„œë¹„ìŠ¤ ì„ íƒ</option>';
                    services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.id;
                        option.textContent = service.name;
                        requestListServiceSelect.appendChild(option);
                    });
                    requestListServiceSelect.disabled = false;
                    requestListContainer.innerHTML = '<p class="text-muted">ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>';
                    downloadExcelBtn.style.display = 'none';
                } catch (error) {
                    console.error('ì„œë¹„ìŠ¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }
        });

        // ì„œë¹„ìŠ¤ ì„ íƒ ë³€ê²½ ì‹œ
        requestListServiceSelect.addEventListener('change', loadRequestList);

        async function loadRequestList() {
            const viewType = viewTypeSelect.value;
            const orgId = requestListOrgSelect.value;
            const serviceId = requestListServiceSelect.value;

            let apiUrl = '';
            currentViewType = viewType;

            if (viewType === 'all') {
                apiUrl = '/api/requests/all';
                currentViewName = 'ì „ì²´';
            } else if (viewType === 'org') {
                if (!orgId) {
                    requestListContainer.innerHTML = '<p class="text-muted">ì¡°ì§ì„ ì„ íƒí•˜ì„¸ìš”.</p>';
                    downloadExcelBtn.style.display = 'none';
                    return;
                }
                apiUrl = `/api/requests/org/${orgId}`;
                currentViewName = requestListOrgSelect.options[requestListOrgSelect.selectedIndex].text;
            } else if (viewType === 'service') {
                if (!serviceId) {
                    requestListContainer.innerHTML = '<p class="text-muted">ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>';
                    downloadExcelBtn.style.display = 'none';
                    return;
                }
                apiUrl = `/api/requests/${serviceId}`;
                currentViewName = requestListServiceSelect.options[requestListServiceSelect.selectedIndex].text;
            }

            try {
                const response = await fetch(apiUrl);
                const requests = await response.json();

                currentRequests = requests; // ë°ì´í„° ì €ì¥

                if (requests.length === 0) {
                    requestListContainer.innerHTML = '<p class="text-muted">ì‹ ì²­ëœ ìº í˜ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    downloadExcelBtn.style.display = 'none';
                    return;
                }

                downloadExcelBtn.style.display = 'inline-block'; // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ

                let html = '<table class="quota-table sortable"><thead><tr>';

                // ì¡°íšŒ íƒ€ì…ì— ë”°ë¼ ì»¬ëŸ¼ ì¶”ê°€
                if (viewType === 'all') {
                    html += '<th class="sortable-header" data-sort-type="text">ì¡°ì§ <span class="sort-arrow"></span></th>';
                    html += '<th class="sortable-header" data-sort-type="text">ì„œë¹„ìŠ¤ <span class="sort-arrow"></span></th>';
                } else if (viewType === 'org') {
                    html += '<th class="sortable-header" data-sort-type="text">ì„œë¹„ìŠ¤ <span class="sort-arrow"></span></th>';
                }

                html += '<th class="sortable-header" data-sort-type="text">ë°œì†¡ì¼ì‹œ <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">ì±„ë„ <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">ìº í˜ì¸ëª… <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="number">ë¬¼ëŸ‰ <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">ë“±ë¡ì¼ì‹œ <span class="sort-arrow"></span></th>';
                html += '<th>ì‘ì—…</th>';
                html += '</tr></thead><tbody>';

                requests.forEach(req => {
                    html += '<tr>';

                    // ì¡°íšŒ íƒ€ì…ì— ë”°ë¼ ì¡°ì§/ì„œë¹„ìŠ¤ ì»¬ëŸ¼ ì¶”ê°€
                    if (viewType === 'all') {
                        html += `<td><strong>${req.org_name}</strong></td>`;
                        html += `<td>${req.service_name}</td>`;
                    } else if (viewType === 'org') {
                        html += `<td>${req.service_name}</td>`;
                    }

                    const dateTime = req.send_time !== '-' ? `${req.send_date} ${req.send_time}` : req.send_date;
                    html += `<td>${dateTime}</td>`;
                    html += `<td><span class="channel-badge channel-${req.channel}">${req.channel_name}</span></td>`;
                    html += `<td>${req.campaign_name}</td>`;
                    html += `<td class="quota-value">${req.quantity.toLocaleString()}ê±´</td>`;
                    html += `<td>${req.created_at}</td>`;
                    html += `<td><button class="btn-delete" onclick="deleteRequest(${req.id})">ì‚­ì œ</button></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                requestListContainer.innerHTML = html;
                makeSortable();
            } catch (error) {
                console.error('ì‹ ì²­ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                requestListContainer.innerHTML = '<p class="text-muted">ì‹ ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ì‹ ì²­ ì‚­ì œ
        window.deleteRequest = async function(requestId) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/request/${requestId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadRequestList();
                    loadQuotaInfo();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        };

        // Excel ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
        downloadExcelBtn.addEventListener('click', () => {
            if (currentRequests.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Excel ë°ì´í„° ì¤€ë¹„ - ì¡°íšŒ íƒ€ì…ì— ë”°ë¼ ì»¬ëŸ¼ êµ¬ì„±
            let excelData;
            let colWidths;

            if (currentViewType === 'all') {
                excelData = currentRequests.map(req => ({
                    'ì¡°ì§': req.org_name,
                    'ì„œë¹„ìŠ¤': req.service_name,
                    'ë°œì†¡ì¼ì': req.send_date,
                    'ë°œì†¡ì‹œê°„': req.send_time || '-',
                    'ì±„ë„': req.channel_name,
                    'ìº í˜ì¸ëª…': req.campaign_name || '-',
                    'ë¬¼ëŸ‰': req.quantity,
                    'ë“±ë¡ì¼ì‹œ': req.created_at
                }));
                colWidths = [
                    { wch: 15 }, // ì¡°ì§
                    { wch: 20 }, // ì„œë¹„ìŠ¤
                    { wch: 12 }, // ë°œì†¡ì¼ì
                    { wch: 10 }, // ë°œì†¡ì‹œê°„
                    { wch: 10 }, // ì±„ë„
                    { wch: 30 }, // ìº í˜ì¸ëª…
                    { wch: 12 }, // ë¬¼ëŸ‰
                    { wch: 18 }  // ë“±ë¡ì¼ì‹œ
                ];
            } else if (currentViewType === 'org') {
                excelData = currentRequests.map(req => ({
                    'ì„œë¹„ìŠ¤': req.service_name,
                    'ë°œì†¡ì¼ì': req.send_date,
                    'ë°œì†¡ì‹œê°„': req.send_time || '-',
                    'ì±„ë„': req.channel_name,
                    'ìº í˜ì¸ëª…': req.campaign_name || '-',
                    'ë¬¼ëŸ‰': req.quantity,
                    'ë“±ë¡ì¼ì‹œ': req.created_at
                }));
                colWidths = [
                    { wch: 20 }, // ì„œë¹„ìŠ¤
                    { wch: 12 }, // ë°œì†¡ì¼ì
                    { wch: 10 }, // ë°œì†¡ì‹œê°„
                    { wch: 10 }, // ì±„ë„
                    { wch: 30 }, // ìº í˜ì¸ëª…
                    { wch: 12 }, // ë¬¼ëŸ‰
                    { wch: 18 }  // ë“±ë¡ì¼ì‹œ
                ];
            } else {
                excelData = currentRequests.map(req => ({
                    'ë°œì†¡ì¼ì': req.send_date,
                    'ë°œì†¡ì‹œê°„': req.send_time || '-',
                    'ì±„ë„': req.channel_name,
                    'ìº í˜ì¸ëª…': req.campaign_name || '-',
                    'ë¬¼ëŸ‰': req.quantity,
                    'ë“±ë¡ì¼ì‹œ': req.created_at
                }));
                colWidths = [
                    { wch: 12 }, // ë°œì†¡ì¼ì
                    { wch: 10 }, // ë°œì†¡ì‹œê°„
                    { wch: 10 }, // ì±„ë„
                    { wch: 30 }, // ìº í˜ì¸ëª…
                    { wch: 12 }, // ë¬¼ëŸ‰
                    { wch: 18 }  // ë“±ë¡ì¼ì‹œ
                ];
            }

            // ì›Œí¬ì‹œíŠ¸ ìƒì„±
            const ws = XLSX.utils.json_to_sheet(excelData);

            // ì—´ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = colWidths;

            // ì›Œí¬ë¶ ìƒì„±
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ìº í˜ì¸ëª©ë¡');

            // íŒŒì¼ëª… ìƒì„± (ì¡°íšŒëª…_ë‚ ì§œ)
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const filename = `${currentViewName}_ìº í˜ì¸ëª©ë¡_${dateStr}.xlsx`;

            // ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(wb, filename);
        });

        // í…Œì´ë¸” ì •ë ¬ ê¸°ëŠ¥
        function makeSortable() {
            const tables = document.querySelectorAll('.sortable');
            tables.forEach(table => {
                const headers = table.querySelectorAll('.sortable-header');
                headers.forEach((header, index) => {
                    header.style.cursor = 'pointer';
                    header.addEventListener('click', () => {
                        sortTable(table, index, header.getAttribute('data-sort-type'));
                    });
                });
            });
        }

        function sortTable(table, columnIndex, sortType) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const header = table.querySelectorAll('.sortable-header')[columnIndex];
            const allHeaders = table.querySelectorAll('.sortable-header');

            // í˜„ì¬ ì •ë ¬ ë°©í–¥ í™•ì¸
            const isAscending = header.classList.contains('sort-asc');

            // ëª¨ë“  í—¤ë”ì˜ ì •ë ¬ í‘œì‹œ ì œê±°
            allHeaders.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
                const arrow = h.querySelector('.sort-arrow');
                if (arrow) arrow.textContent = '';
            });

            // ìƒˆë¡œìš´ ì •ë ¬ ë°©í–¥ ì„¤ì •
            const ascending = !isAscending;
            header.classList.add(ascending ? 'sort-asc' : 'sort-desc');
            const arrow = header.querySelector('.sort-arrow');
            if (arrow) arrow.textContent = ascending ? ' â–²' : ' â–¼';

            // í–‰ ì •ë ¬
            rows.sort((a, b) => {
                const aCell = a.cells[columnIndex];
                const bCell = b.cells[columnIndex];

                let aValue = aCell.textContent.trim();
                let bValue = bCell.textContent.trim();

                if (sortType === 'number') {
                    // ìˆ«ìì™€ ì‰¼í‘œ ì œê±°
                    aValue = parseInt(aValue.replace(/[^0-9]/g, '')) || 0;
                    bValue = parseInt(bValue.replace(/[^0-9]/g, '')) || 0;
                    return ascending ? aValue - bValue : bValue - aValue;
                } else {
                    // í…ìŠ¤íŠ¸ ì •ë ¬
                    return ascending
                        ? aValue.localeCompare(bValue, 'ko')
                        : bValue.localeCompare(aValue, 'ko');
                }
            });

            // ì •ë ¬ëœ í–‰ì„ ë‹¤ì‹œ ì¶”ê°€
            rows.forEach(row => tbody.appendChild(row));
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ì²´ ëª©ë¡ ìë™ ì¡°íšŒ
        loadRequestList();
    </script>
</body>
</html>