<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 - 조직별 물량 설정</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>광고성 알림 물량 관리</h1>
            <ul class="nav-menu">
                <li><a href="/admin" class="active">관리자</a></li>
                <li><a href="/request">캠페인신청</a></li>
                <li><a href="/calendar">현황보기</a></li>
                <li><a href="/admin/logout">로그아웃</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h2>관리자 페이지</h2>

        <!-- 탭 메뉴 -->
        <div class="admin-tabs">
            <button class="tab-btn active" data-tab="quota">물량 설정</button>
            <button class="tab-btn" data-tab="manage">조직/서비스 관리</button>
            <button class="tab-btn" data-tab="freeze">프리징 관리</button>
            <button class="tab-btn" data-tab="changes">변경 요청</button>
        </div>

        <!-- 물량 설정 탭 -->
        <div id="quotaTab" class="tab-content active">
            <h3>조직별 월간 물량 설정</h3>

        <div class="form-card">
            <form id="quotaForm">
                <div class="form-group">
                    <label for="organization">조직</label>
                    <select id="organization" required>
                        <option value="">조직 선택</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}">{{ org.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="channel">발송 채널</label>
                    <select id="channel" required>
                        <option value="naver">네이버앱</option>
                        <option value="payco">페이앱</option>
                        <option value="talktalk">톡톡</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="yearMonth">연월</label>
                    <input type="month" id="yearMonth" required>
                </div>

                <div class="form-group">
                    <label for="totalQuota">총 물량</label>
                    <input type="text" id="totalQuotaDisplay" placeholder="예: 10만" required>
                    <input type="hidden" id="totalQuota">
                    <div class="quantity-display">
                        <span id="quotaRealValue">0건</span>
                    </div>
                    <small class="help-text">예시: 1천(1,000) / 5만(50,000) / 100만(1,000,000)</small>
                </div>

                <button type="submit" class="btn btn-primary">물량 설정</button>
            </form>
        </div>

            <div class="quota-list">
                <h3>전체 등록된 물량 목록</h3>

                <div class="filter-section">
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex: 1;">
                            <label for="filterYearMonth">연월 필터</label>
                            <input type="month" id="filterYearMonth">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="filterChannel">채널 필터</label>
                            <select id="filterChannel">
                                <option value="">전체</option>
                                <option value="naver">네이버앱</option>
                                <option value="payco">페이앱</option>
                                <option value="talktalk">톡톡</option>
                            </select>
                        </div>
                        <button type="button" id="searchQuotaBtn" class="btn btn-primary">조회하기</button>
                    </div>
                </div>

                <hr style="margin: 2rem 0; border: none; border-top: 2px solid #dee2e6;">

                <div class="copy-section">
                    <h4>📋 물량 복사하기</h4>
                    <p class="help-text">특정 월의 모든 조직 물량을 다른 월로 복사할 수 있습니다.</p>
                    <div class="copy-form">
                        <div class="form-group">
                            <label for="copySourceMonth">복사할 원본 월</label>
                            <input type="month" id="copySourceMonth" required>
                        </div>
                        <div class="copy-arrow">→</div>
                        <div class="form-group">
                            <label for="copyTargetMonth">복사될 대상 월</label>
                            <input type="month" id="copyTargetMonth" required>
                        </div>
                        <button type="button" id="copyQuotaBtn" class="btn btn-primary">복사하기</button>
                    </div>
                </div>

                <hr style="margin: 2rem 0; border: none; border-top: 2px solid #dee2e6;">

                <div id="allQuotaListContainer">
                    <p class="text-muted">로딩 중...</p>
                </div>
            </div>
        </div>

        <!-- 프리징 관리 탭 -->
        <div id="freezeTab" class="tab-content">
            <h3>월별 프리징 관리</h3>
            <div class="form-card">
                <p class="help-text">프리징된 월은 일반 사용자가 캠페인을 직접 수정/삭제할 수 없으며, 변경 요청을 통해서만 수정이 가능합니다.</p>

                <div class="form-group">
                    <label for="freezeYearMonth">월 선택</label>
                    <input type="month" id="freezeYearMonth" required>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="button" id="freezeBtn" class="btn btn-primary">프리징 설정</button>
                    <button type="button" id="unfreezeBtn" class="btn btn-secondary">프리징 해제</button>
                </div>
            </div>

            <h3 style="margin-top: 2rem;">프리징 현황</h3>
            <div class="form-card">
                <div id="freezeListContainer">
                    <p class="text-muted">로딩 중...</p>
                </div>
            </div>
        </div>

        <!-- 변경 요청 관리 탭 -->
        <div id="changesTab" class="tab-content">
            <h3>변경 요청 승인 관리</h3>

            <div class="filter-section">
                <div style="display: flex; gap: 1rem; align-items: flex-end;">
                    <div class="form-group" style="flex: 1;">
                        <label for="filterChangeStatus">상태 필터</label>
                        <select id="filterChangeStatus">
                            <option value="">전체</option>
                            <option value="pending">대기중</option>
                            <option value="approved">승인</option>
                            <option value="rejected">거부</option>
                        </select>
                    </div>
                    <button type="button" id="searchChangeBtn" class="btn btn-primary">조회하기</button>
                </div>
            </div>

            <div class="form-card" style="margin-top: 1rem;">
                <div id="changeRequestsContainer">
                    <p class="text-muted">로딩 중...</p>
                </div>
            </div>
        </div>

        <!-- 조직/서비스 관리 탭 -->
        <div id="manageTab" class="tab-content">
            <h3>조직 관리</h3>
            <div class="form-card">
                <form id="orgForm">
                    <div class="form-group">
                        <label for="orgName">조직명</label>
                        <input type="text" id="orgName" placeholder="예: 대출" required>
                    </div>
                    <button type="submit" class="btn btn-primary">조직 추가</button>
                </form>
            </div>

            <h3 style="margin-top: 2rem;">서비스 관리</h3>
            <div class="form-card">
                <form id="serviceForm">
                    <div class="form-group">
                        <label for="serviceOrg">조직</label>
                        <select id="serviceOrg" required>
                            <option value="">조직 선택</option>
                            {% for org in organizations %}
                            <option value="{{ org.id }}">{{ org.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="serviceName">서비스명</label>
                        <input type="text" id="serviceName" placeholder="예: 신용대출" required>
                    </div>
                    <div class="form-group">
                        <label for="managerName">담당자명</label>
                        <input type="text" id="managerName" placeholder="예: 홍길동">
                    </div>
                    <button type="submit" class="btn btn-primary">서비스 추가</button>
                </form>
            </div>

            <h3 style="margin-top: 2rem;">등록된 조직 목록</h3>
            <div class="form-card">
                <div id="orgListContainer">
                    <p class="text-muted">로딩 중...</p>
                </div>
            </div>

            <h3 style="margin-top: 2rem;">등록된 서비스 목록</h3>
            <div class="form-card">
                <div id="serviceListContainer">
                    <p class="text-muted">로딩 중...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('quotaForm');
        const orgSelect = document.getElementById('organization');
        const channelSelect = document.getElementById('channel');
        const yearMonthInput = document.getElementById('yearMonth');
        const quotaDisplayInput = document.getElementById('totalQuotaDisplay');
        const quotaHiddenInput = document.getElementById('totalQuota');
        const quotaRealValue = document.getElementById('quotaRealValue');

        // 현재 날짜 기준 다음 달로 기본값 설정
        const today = new Date();
        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        yearMonthInput.value = nextMonth.toISOString().slice(0, 7);

        // 물량 입력 변환 함수
        function parseKoreanNumber(input) {
            if (!input) return 0;

            // 쉼표 제거
            input = input.replace(/,/g, '');

            // 숫자만 있는 경우
            if (/^\d+$/.test(input)) {
                return parseInt(input);
            }

            // 한글 단위 처리
            let result = 0;

            // 만 단위 처리
            const manMatch = input.match(/(\d+(?:\.\d+)?)\s*만/);
            if (manMatch) {
                result += parseFloat(manMatch[1]) * 10000;
            }

            // 천 단위 처리
            const cheonMatch = input.match(/(\d+(?:\.\d+)?)\s*천/);
            if (cheonMatch) {
                result += parseFloat(cheonMatch[1]) * 1000;
            }

            // 백 단위 처리
            const baekMatch = input.match(/(\d+(?:\.\d+)?)\s*백/);
            if (baekMatch) {
                result += parseFloat(baekMatch[1]) * 100;
            }

            return Math.floor(result);
        }

        // 실시간 변환 표시
        quotaDisplayInput.addEventListener('input', () => {
            const value = parseKoreanNumber(quotaDisplayInput.value);
            quotaHiddenInput.value = value;
            quotaRealValue.textContent = value.toLocaleString() + '건';
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const quota = parseInt(quotaHiddenInput.value);

            if (quota < 100 || quota > 10000000) {
                alert('물량은 100건 이상 1,000만건 이하로 입력해주세요.');
                return;
            }

            const data = {
                organization_id: parseInt(orgSelect.value),
                channel: channelSelect.value,
                year_month: yearMonthInput.value,
                total_quota: quota
            };

            try {
                const response = await fetch('/api/quota', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    quotaDisplayInput.value = '';
                    quotaHiddenInput.value = '';
                    quotaRealValue.textContent = '0건';
                    loadQuota(); // 목록 새로고침
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('물량 설정 중 오류가 발생했습니다.');
                console.error(error);
            }
        });

        // 조직 또는 연월 변경 시 설정된 물량 조회
        async function loadQuota() {
            if (!orgSelect.value || !yearMonthInput.value) return;

            try {
                const response = await fetch(`/api/quota/${orgSelect.value}/${yearMonthInput.value}`);
                const data = await response.json();

                const container = document.getElementById('quotaListContainer');
                if (data.total_quota > 0) {
                    container.innerHTML = `
                        <div class="quota-item">
                            <strong>${orgSelect.options[orgSelect.selectedIndex].text}</strong>
                            <span>${yearMonthInput.value}</span>
                            <span class="quota-value">${data.total_quota.toLocaleString()}건</span>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p class="text-muted">설정된 물량이 없습니다.</p>';
                }
            } catch (error) {
                console.error('물량 조회 중 오류:', error);
            }
        }

        orgSelect.addEventListener('change', loadQuota);
        yearMonthInput.addEventListener('change', loadQuota);

        // 전체 물량 목록 로드
        const filterYearMonthInput = document.getElementById('filterYearMonth');
        const filterChannelSelect = document.getElementById('filterChannel');
        const searchQuotaBtn = document.getElementById('searchQuotaBtn');
        const allQuotaListContainer = document.getElementById('allQuotaListContainer');

        // 기본값 설정 (다음 달)
        filterYearMonthInput.value = nextMonth.toISOString().slice(0, 7);

        // 초기 로드 메시지
        allQuotaListContainer.innerHTML = '<p class="text-muted">조회하기 버튼을 눌러주세요.</p>';

        // 채널명 매핑
        const channelNames = {
            'naver': '네이버앱',
            'payco': '페이앱',
            'talktalk': '톡톡'
        };

        async function loadAllQuotas() {
            const yearMonth = filterYearMonthInput.value;
            const channel = filterChannelSelect.value;

            try {
                let url = '/api/quotas?';
                if (yearMonth) url += `year_month=${yearMonth}&`;
                if (channel) url += `channel=${channel}&`;

                const response = await fetch(url);
                const quotas = await response.json();

                if (quotas.length === 0) {
                    allQuotaListContainer.innerHTML = '<p class="text-muted">등록된 물량이 없습니다.</p>';
                    return;
                }

                let html = '<table class="quota-table sortable"><thead><tr>';
                html += '<th class="sortable-header" data-sort-type="text">조직 <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">채널 <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">연월 <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="number">총 물량 <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">등록일시 <span class="sort-arrow"></span></th>';
                html += '<th>작업</th>';
                html += '</tr></thead><tbody>';

                quotas.forEach(quota => {
                    html += '<tr>';
                    html += `<td><strong>${quota.organization_name}</strong></td>`;
                    html += `<td><span class="channel-badge channel-${quota.channel}">${channelNames[quota.channel]}</span></td>`;
                    html += `<td>${quota.year_month}</td>`;
                    html += `<td class="quota-value">${quota.total_quota.toLocaleString()}건</td>`;
                    html += `<td>${quota.created_at}</td>`;
                    html += `<td class="action-buttons">`;
                    html += `<button class="btn-edit" onclick="editQuota(${quota.id}, '${quota.organization_name}', '${quota.channel}', '${quota.year_month}', ${quota.total_quota})">수정</button>`;
                    html += `<button class="btn-delete" onclick="deleteQuota(${quota.id}, '${quota.organization_name}', '${quota.channel}', '${quota.year_month}')">삭제</button>`;
                    html += `</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                allQuotaListContainer.innerHTML = html;
                makeSortable();
            } catch (error) {
                console.error('물량 목록 로드 실패:', error);
                allQuotaListContainer.innerHTML = '<p class="text-muted">물량 목록을 불러오는데 실패했습니다.</p>';
            }
        }

        // 조회하기 버튼 클릭 시에만 로드
        searchQuotaBtn.addEventListener('click', loadAllQuotas);

        // 물량 복사 기능
        const copySourceMonthInput = document.getElementById('copySourceMonth');
        const copyTargetMonthInput = document.getElementById('copyTargetMonth');
        const copyQuotaBtn = document.getElementById('copyQuotaBtn');

        // 기본값 설정
        const currentMonth = new Date();
        copySourceMonthInput.value = currentMonth.toISOString().slice(0, 7);
        copyTargetMonthInput.value = nextMonth.toISOString().slice(0, 7);

        copyQuotaBtn.addEventListener('click', async () => {
            const sourceMonth = copySourceMonthInput.value;
            const targetMonth = copyTargetMonthInput.value;

            if (!sourceMonth || !targetMonth) {
                alert('원본 월과 대상 월을 모두 선택해주세요.');
                return;
            }

            if (sourceMonth === targetMonth) {
                alert('원본 월과 대상 월이 같을 수 없습니다.');
                return;
            }

            // 원본 월 물량 미리보기
            try {
                const previewResponse = await fetch(`/api/quotas?year_month=${sourceMonth}`);
                const sourceQuotas = await previewResponse.json();

                if (sourceQuotas.length === 0) {
                    alert('원본 월에 설정된 물량이 없습니다.');
                    return;
                }

                let previewText = `${sourceMonth} → ${targetMonth}\n\n`;
                previewText += `복사될 조직 (${sourceQuotas.length}개):\n`;
                sourceQuotas.forEach(quota => {
                    previewText += `- ${quota.organization_name}: ${quota.total_quota.toLocaleString()}건\n`;
                });
                previewText += `\n계속하시겠습니까?`;

                if (!confirm(previewText)) {
                    return;
                }

                // 복사 실행
                const response = await fetch('/api/quotas/copy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        source_year_month: sourceMonth,
                        target_year_month: targetMonth
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    filterYearMonthInput.value = targetMonth;
                    loadAllQuotas();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('물량 복사 중 오류가 발생했습니다.');
                console.error(error);
            }
        });

        // 물량 수정
        window.editQuota = async function(quotaId, orgName, channel, yearMonth, currentQuota) {
            const channelName = channelNames[channel];
            const input = prompt(`${orgName} - ${channelName} (${yearMonth}) 물량 수정\n\n예: 10만, 50만, 100만 등으로 입력`, '');

            if (!input) return;

            const newQuota = parseKoreanNumber(input);

            if (newQuota < 100 || newQuota > 10000000) {
                alert('물량은 100건 이상 1,000만건 이하로 입력해주세요.');
                return;
            }

            if (!confirm(`${orgName} - ${channelName} (${yearMonth}) 물량을\n${currentQuota.toLocaleString()}건 → ${newQuota.toLocaleString()}건\n으로 수정하시겠습니까?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/quota/${quotaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ total_quota: newQuota })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadAllQuotas();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('물량 수정 중 오류가 발생했습니다.');
                console.error(error);
            }
        };

        // 물량 삭제
        window.deleteQuota = async function(quotaId, orgName, channel, yearMonth) {
            const channelName = channelNames[channel];
            if (!confirm(`${orgName} - ${channelName} (${yearMonth}) 물량을 삭제하시겠습니까?\n\n⚠️ 삭제 후에는 복구할 수 없습니다.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/quota/${quotaId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadAllQuotas();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('물량 삭제 중 오류가 발생했습니다.');
                console.error(error);
            }
        };

        // 탭 전환
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;

                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // 조직 추가
        const orgForm = document.getElementById('orgForm');
        orgForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('orgName').value;

            try {
                const response = await fetch('/api/organization', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    document.getElementById('orgName').value = '';

                    // 드롭다운에 새 조직 추가 (새로고침 없이)
                    const newOption = document.createElement('option');
                    newOption.value = result.id;
                    newOption.textContent = name;
                    orgSelect.appendChild(newOption);

                    const serviceOrgSelect = document.getElementById('serviceOrg');
                    const newOption2 = document.createElement('option');
                    newOption2.value = result.id;
                    newOption2.textContent = name;
                    serviceOrgSelect.appendChild(newOption2);

                    loadOrgList();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('조직 추가 중 오류가 발생했습니다.');
                console.error(error);
            }
        });

        // 서비스 추가
        const serviceForm = document.getElementById('serviceForm');
        serviceForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                organization_id: parseInt(document.getElementById('serviceOrg').value),
                name: document.getElementById('serviceName').value,
                manager_name: document.getElementById('managerName').value
            };

            try {
                const response = await fetch('/api/service', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    serviceForm.reset();
                    loadOrgList();
                    loadServiceList();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('서비스 추가 중 오류가 발생했습니다.');
                console.error(error);
            }
        });

        // 조직 목록 로드
        async function loadOrgList() {
            try {
                const response = await fetch('/api/organizations');
                const orgs = await response.json();

                const container = document.getElementById('orgListContainer');
                if (orgs.length === 0) {
                    container.innerHTML = '<p class="text-muted">등록된 조직이 없습니다.</p>';
                    return;
                }

                let html = '<table class="quota-table sortable"><thead><tr>';
                html += '<th class="sortable-header" data-sort-type="text">조직명 <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">등록일시 <span class="sort-arrow"></span></th>';
                html += '<th>관리</th>';
                html += '</tr></thead><tbody>';

                orgs.forEach(org => {
                    html += `<tr id="org-row-${org.id}">`;
                    html += `<td>`;
                    html += `<span id="org-name-${org.id}" class="editable-text">${org.name}</span>`;
                    html += `<input type="text" id="org-input-${org.id}" class="edit-input" value="${org.name}" style="display: none;">`;
                    html += `</td>`;
                    html += `<td>${org.created_at}</td>`;
                    html += `<td><div class="action-buttons">`;
                    html += `<button class="btn-edit" id="org-edit-btn-${org.id}" onclick="startEditOrg(${org.id})">수정</button>`;
                    html += `<button class="btn-delete" onclick="deleteOrg(${org.id}, '${org.name.replace(/'/g, "\\'")}')">삭제</button>`;
                    html += `<button class="btn-primary" id="org-save-btn-${org.id}" onclick="saveOrg(${org.id})" style="display: none;">저장</button>`;
                    html += `<button class="btn-secondary" id="org-cancel-btn-${org.id}" onclick="cancelEditOrg(${org.id}, '${org.name.replace(/'/g, "\\'")}')\" style="display: none;">취소</button>`;
                    html += `</div></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
                makeSortable();
            } catch (error) {
                console.error('조직 목록 로드 실패:', error);
            }
        }

        // 서비스 목록 로드
        async function loadServiceList() {
            try {
                const response = await fetch('/api/services');
                const services = await response.json();

                const container = document.getElementById('serviceListContainer');
                if (services.length === 0) {
                    container.innerHTML = '<p class="text-muted">등록된 서비스가 없습니다.</p>';
                    return;
                }

                let html = '<table class="quota-table sortable"><thead><tr>';
                html += '<th class="sortable-header" data-sort-type="text">조직 <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">서비스명 <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">담당자 <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">등록일시 <span class="sort-arrow"></span></th>';
                html += '<th>관리</th>';
                html += '</tr></thead><tbody>';

                services.forEach(service => {
                    html += `<tr id="service-row-${service.id}" data-org-id="${service.organization_id}">`;
                    html += `<td><strong>${service.organization_name}</strong></td>`;
                    html += `<td>`;
                    html += `<span id="service-name-${service.id}" class="editable-text">${service.name}</span>`;
                    html += `<input type="text" id="service-name-input-${service.id}" class="edit-input" value="${service.name}" style="display: none;">`;
                    html += `</td>`;
                    html += `<td>`;
                    html += `<span id="service-manager-${service.id}" class="editable-text">${service.manager_name || '-'}</span>`;
                    html += `<input type="text" id="service-manager-input-${service.id}" class="edit-input" value="${service.manager_name || ''}" style="display: none;">`;
                    html += `</td>`;
                    html += `<td>${service.created_at}</td>`;
                    html += `<td><div class="action-buttons">`;
                    html += `<button class="btn-edit" id="service-edit-btn-${service.id}" onclick="startEditService(${service.id})">수정</button>`;
                    html += `<button class="btn-delete" onclick="deleteService(${service.id}, '${service.name.replace(/'/g, "\\'")}')">삭제</button>`;
                    html += `<button class="btn-primary" id="service-save-btn-${service.id}" onclick="saveService(${service.id})" style="display: none;">저장</button>`;
                    html += `<button class="btn-secondary" id="service-cancel-btn-${service.id}" onclick="cancelEditService(${service.id}, '${service.name.replace(/'/g, "\\'")}', '${(service.manager_name || '').replace(/'/g, "\\'")}')\" style="display: none;">취소</button>`;
                    html += `</div></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
                makeSortable();
            } catch (error) {
                console.error('서비스 목록 로드 실패:', error);
            }
        }

        // 조직 수정 - 인라인 편집 시작
        window.startEditOrg = function(orgId) {
            document.getElementById(`org-name-${orgId}`).style.display = 'none';
            document.getElementById(`org-input-${orgId}`).style.display = 'inline-block';
            document.getElementById(`org-edit-btn-${orgId}`).style.display = 'none';
            document.getElementById(`org-save-btn-${orgId}`).style.display = 'inline-block';
            document.getElementById(`org-cancel-btn-${orgId}`).style.display = 'inline-block';
            document.getElementById(`org-input-${orgId}`).focus();
        };

        // 조직 수정 취소
        window.cancelEditOrg = function(orgId, originalName) {
            document.getElementById(`org-input-${orgId}`).value = originalName;
            document.getElementById(`org-name-${orgId}`).style.display = 'inline';
            document.getElementById(`org-input-${orgId}`).style.display = 'none';
            document.getElementById(`org-edit-btn-${orgId}`).style.display = 'inline-block';
            document.getElementById(`org-save-btn-${orgId}`).style.display = 'none';
            document.getElementById(`org-cancel-btn-${orgId}`).style.display = 'none';
        };

        // 조직 저장
        window.saveOrg = async function(orgId) {
            const newName = document.getElementById(`org-input-${orgId}`).value.trim();
            if (!newName) {
                alert('조직명을 입력하세요.');
                return;
            }

            try {
                const response = await fetch(`/api/organization/${orgId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message + '\n\n페이지를 새로고침하여 모든 조직명을 업데이트합니다.');

                    // 화면 전체 새로고침하여 모든 조직명 동기화
                    location.reload();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('조직 수정 중 오류가 발생했습니다.');
                console.error(error);
            }
        };

        // 서비스 수정 - 인라인 편집 시작
        window.startEditService = function(serviceId) {
            document.getElementById(`service-name-${serviceId}`).style.display = 'none';
            document.getElementById(`service-name-input-${serviceId}`).style.display = 'inline-block';
            document.getElementById(`service-manager-${serviceId}`).style.display = 'none';
            document.getElementById(`service-manager-input-${serviceId}`).style.display = 'inline-block';
            document.getElementById(`service-edit-btn-${serviceId}`).style.display = 'none';
            document.getElementById(`service-save-btn-${serviceId}`).style.display = 'inline-block';
            document.getElementById(`service-cancel-btn-${serviceId}`).style.display = 'inline-block';
            document.getElementById(`service-name-input-${serviceId}`).focus();
        };

        // 서비스 수정 취소
        window.cancelEditService = function(serviceId, originalName, originalManager) {
            document.getElementById(`service-name-input-${serviceId}`).value = originalName;
            document.getElementById(`service-manager-input-${serviceId}`).value = originalManager;
            document.getElementById(`service-name-${serviceId}`).style.display = 'inline';
            document.getElementById(`service-name-input-${serviceId}`).style.display = 'none';
            document.getElementById(`service-manager-${serviceId}`).style.display = 'inline';
            document.getElementById(`service-manager-input-${serviceId}`).style.display = 'none';
            document.getElementById(`service-edit-btn-${serviceId}`).style.display = 'inline-block';
            document.getElementById(`service-save-btn-${serviceId}`).style.display = 'none';
            document.getElementById(`service-cancel-btn-${serviceId}`).style.display = 'none';
        };

        // 서비스 저장
        window.saveService = async function(serviceId) {
            const newName = document.getElementById(`service-name-input-${serviceId}`).value.trim();
            const newManager = document.getElementById(`service-manager-input-${serviceId}`).value.trim();

            if (!newName) {
                alert('서비스명을 입력하세요.');
                return;
            }

            // data-org-id 속성에서 organization_id 가져오기
            const row = document.getElementById(`service-row-${serviceId}`);
            const orgId = row.getAttribute('data-org-id');

            console.log('Saving service:', {serviceId, newName, newManager, orgId}); // 디버그용

            try {
                const response = await fetch(`/api/service/${serviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: newName,
                        organization_id: parseInt(orgId),
                        manager_name: newManager
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);

                    // 화면 업데이트 (새로고침 없이)
                    document.getElementById(`service-name-${serviceId}`).textContent = newName;
                    document.getElementById(`service-manager-${serviceId}`).textContent = newManager || '-';

                    // 편집 모드 종료
                    document.getElementById(`service-name-${serviceId}`).style.display = 'inline';
                    document.getElementById(`service-name-input-${serviceId}`).style.display = 'none';
                    document.getElementById(`service-manager-${serviceId}`).style.display = 'inline';
                    document.getElementById(`service-manager-input-${serviceId}`).style.display = 'none';
                    document.getElementById(`service-edit-btn-${serviceId}`).style.display = 'inline-block';
                    document.getElementById(`service-save-btn-${serviceId}`).style.display = 'none';
                    document.getElementById(`service-cancel-btn-${serviceId}`).style.display = 'none';
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('서비스 수정 중 오류가 발생했습니다.');
                console.error(error);
            }
        };

        // 조직 삭제
        window.deleteOrg = async function(orgId, orgName) {
            if (!confirm(`"${orgName}" 조직을 삭제하시겠습니까?\n\n⚠️ 이 조직에 서비스나 물량 정보가 있으면 삭제할 수 없습니다.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/organization/${orgId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadOrgList();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('조직 삭제 중 오류가 발생했습니다.');
                console.error(error);
            }
        };

        // 서비스 삭제
        window.deleteService = async function(serviceId, serviceName) {
            if (!confirm(`"${serviceName}" 서비스를 삭제하시겠습니까?\n\n⚠️ 이 서비스에 캠페인 신청이 있으면 삭제할 수 없습니다.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/service/${serviceId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadServiceList();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('서비스 삭제 중 오류가 발생했습니다.');
                console.error(error);
            }
        };

        // 탭 전환 시 목록 로드
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                if (tabName === 'manage') {
                    loadOrgList();
                    loadServiceList();
                } else if (tabName === 'freeze') {
                    loadFreezeList();
                } else if (tabName === 'changes') {
                    loadChangeRequests();
                }
            });
        });

        // 프리징 관리
        const freezeYearMonthInput = document.getElementById('freezeYearMonth');
        const freezeBtn = document.getElementById('freezeBtn');
        const unfreezeBtn = document.getElementById('unfreezeBtn');
        const freezeListContainer = document.getElementById('freezeListContainer');

        // 기본값 설정 (다음 달)
        const nextMonthForFreeze = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        freezeYearMonthInput.value = nextMonthForFreeze.toISOString().slice(0, 7);

        // 프리징 설정
        freezeBtn.addEventListener('click', async () => {
            const yearMonth = freezeYearMonthInput.value;
            if (!yearMonth) {
                alert('월을 선택해주세요.');
                return;
            }

            if (!confirm(`${yearMonth}을(를) 프리징하시겠습니까?\n\n프리징 후에는 일반 사용자가 캠페인을 직접 수정/삭제할 수 없습니다.`)) {
                return;
            }

            try {
                const response = await fetch('/api/freeze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year_month: yearMonth, is_frozen: true })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    loadFreezeList();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('프리징 설정 중 오류가 발생했습니다.');
                console.error(error);
            }
        });

        // 프리징 해제
        unfreezeBtn.addEventListener('click', async () => {
            const yearMonth = freezeYearMonthInput.value;
            if (!yearMonth) {
                alert('월을 선택해주세요.');
                return;
            }

            if (!confirm(`${yearMonth}의 프리징을 해제하시겠습니까?`)) {
                return;
            }

            try {
                const response = await fetch('/api/freeze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year_month: yearMonth, is_frozen: false })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    loadFreezeList();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('프리징 해제 중 오류가 발생했습니다.');
                console.error(error);
            }
        });

        // 프리징 목록 로드
        async function loadFreezeList() {
            try {
                const response = await fetch('/api/freezes');
                const freezes = await response.json();

                if (freezes.length === 0) {
                    freezeListContainer.innerHTML = '<p class="text-muted">설정된 프리징이 없습니다.</p>';
                    return;
                }

                let html = '<table class="quota-table"><thead><tr>';
                html += '<th>연월</th><th>상태</th><th>프리징 일시</th><th>처리자</th>';
                html += '</tr></thead><tbody>';

                freezes.forEach(freeze => {
                    html += '<tr>';
                    html += `<td><strong>${freeze.year_month}</strong></td>`;
                    html += `<td>`;
                    if (freeze.is_frozen) {
                        html += '<span style="color: #e74c3c; font-weight: bold;">🔒 프리징</span>';
                    } else {
                        html += '<span style="color: #27ae60;">🔓 해제</span>';
                    }
                    html += `</td>`;
                    html += `<td>${freeze.frozen_at || '-'}</td>`;
                    html += `<td>${freeze.frozen_by || '-'}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                freezeListContainer.innerHTML = html;
            } catch (error) {
                console.error('프리징 목록 로드 실패:', error);
                freezeListContainer.innerHTML = '<p class="text-muted">프리징 목록을 불러오는데 실패했습니다.</p>';
            }
        }

        // 변경 요청 관리
        const filterChangeStatus = document.getElementById('filterChangeStatus');
        const searchChangeBtn = document.getElementById('searchChangeBtn');
        const changeRequestsContainer = document.getElementById('changeRequestsContainer');

        searchChangeBtn.addEventListener('click', loadChangeRequests);

        async function loadChangeRequests() {
            const status = filterChangeStatus.value;

            try {
                let url = '/api/change-requests';
                if (status) url += `?status=${status}`;

                const response = await fetch(url);
                const requests = await response.json();

                if (requests.length === 0) {
                    changeRequestsContainer.innerHTML = '<p class="text-muted">변경 요청이 없습니다.</p>';
                    return;
                }

                let html = '<table class="quota-table"><thead><tr>';
                html += '<th>연월</th><th>유형</th><th>조직</th><th>서비스</th><th>요청 내용</th><th>요청자</th><th>상태</th><th>요청일시</th><th>작업</th>';
                html += '</tr></thead><tbody>';

                requests.forEach(req => {
                    html += '<tr>';
                    html += `<td>${req.year_month}</td>`;
                    html += `<td><strong>${req.request_type_name}</strong></td>`;
                    html += `<td>${req.org_name}</td>`;
                    html += `<td>${req.service_name}</td>`;

                    // 요청 내용 요약
                    let content = '';
                    if (req.send_date) content += `날짜: ${req.send_date}<br>`;
                    if (req.send_time) content += `시간: ${req.send_time}<br>`;
                    if (req.channel_name) content += `채널: ${req.channel_name}<br>`;
                    if (req.campaign_name && req.campaign_name !== '-') content += `캠페인: ${req.campaign_name}<br>`;
                    if (req.quantity) content += `물량: ${req.quantity.toLocaleString()}건<br>`;
                    content += `사유: ${req.reason}`;
                    html += `<td style="font-size: 0.85rem;">${content}</td>`;

                    html += `<td>${req.requester_name}</td>`;

                    let statusColor = req.status === 'pending' ? '#f39c12' : (req.status === 'approved' ? '#27ae60' : '#e74c3c');
                    html += `<td><span style="color: ${statusColor}; font-weight: bold;">${req.status_name}</span></td>`;
                    html += `<td>${req.created_at}</td>`;

                    html += `<td class="action-buttons">`;
                    if (req.status === 'pending') {
                        html += `<button class="btn-edit" onclick="approveChange(${req.id})">승인</button>`;
                        html += `<button class="btn-delete" onclick="rejectChange(${req.id})">거부</button>`;
                    } else {
                        html += `<button class="btn-secondary" onclick="viewChangeDetail(${req.id}, '${req.status_name}', '${req.admin_memo || ''}', '${req.processed_by || ''}', '${req.processed_at || ''}')">상세</button>`;
                    }
                    html += `</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                changeRequestsContainer.innerHTML = html;
            } catch (error) {
                console.error('변경 요청 로드 실패:', error);
                changeRequestsContainer.innerHTML = '<p class="text-muted">변경 요청을 불러오는데 실패했습니다.</p>';
            }
        }

        // 변경 요청 승인
        window.approveChange = async function(requestId) {
            const memo = prompt('승인 메모 (선택사항):');
            if (memo === null) return; // 취소

            try {
                const response = await fetch(`/api/change-request/${requestId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'approve', admin_memo: memo })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    loadChangeRequests();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('승인 중 오류가 발생했습니다.');
                console.error(error);
            }
        };

        // 변경 요청 거부
        window.rejectChange = async function(requestId) {
            const memo = prompt('거부 사유를 입력해주세요:');
            if (!memo) {
                alert('거부 사유를 입력해주세요.');
                return;
            }

            try {
                const response = await fetch(`/api/change-request/${requestId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'reject', admin_memo: memo })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    loadChangeRequests();
                } else {
                    alert('오류: ' + result.message);
                }
            } catch (error) {
                alert('거부 중 오류가 발생했습니다.');
                console.error(error);
            }
        };

        // 변경 요청 상세 보기
        window.viewChangeDetail = function(requestId, status, memo, processedBy, processedAt) {
            let message = `상태: ${status}\n`;
            if (memo) message += `관리자 메모: ${memo}\n`;
            if (processedBy) message += `처리자: ${processedBy}\n`;
            if (processedAt) message += `처리일시: ${processedAt}\n`;
            alert(message);
        };

        // 테이블 정렬 기능
        function makeSortable() {
            const tables = document.querySelectorAll('.sortable');
            tables.forEach(table => {
                const headers = table.querySelectorAll('.sortable-header');
                headers.forEach((header, index) => {
                    header.style.cursor = 'pointer';
                    header.addEventListener('click', () => {
                        sortTable(table, index, header.getAttribute('data-sort-type'));
                    });
                });
            });
        }

        function sortTable(table, columnIndex, sortType) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const header = table.querySelectorAll('.sortable-header')[columnIndex];
            const allHeaders = table.querySelectorAll('.sortable-header');

            // 현재 정렬 방향 확인
            const isAscending = header.classList.contains('sort-asc');

            // 모든 헤더의 정렬 표시 제거
            allHeaders.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
                const arrow = h.querySelector('.sort-arrow');
                if (arrow) arrow.textContent = '';
            });

            // 새로운 정렬 방향 설정
            const ascending = !isAscending;
            header.classList.add(ascending ? 'sort-asc' : 'sort-desc');
            const arrow = header.querySelector('.sort-arrow');
            if (arrow) arrow.textContent = ascending ? ' ▲' : ' ▼';

            // 행 정렬
            rows.sort((a, b) => {
                const aCell = a.cells[columnIndex];
                const bCell = b.cells[columnIndex];

                let aValue = aCell.textContent.trim();
                let bValue = bCell.textContent.trim();

                if (sortType === 'number') {
                    // 숫자와 쉼표 제거
                    aValue = parseInt(aValue.replace(/[^0-9]/g, '')) || 0;
                    bValue = parseInt(bValue.replace(/[^0-9]/g, '')) || 0;
                    return ascending ? aValue - bValue : bValue - aValue;
                } else {
                    // 텍스트 정렬
                    return ascending
                        ? aValue.localeCompare(bValue, 'ko')
                        : bValue.localeCompare(aValue, 'ko');
                }
            });

            // 정렬된 행을 다시 추가
            rows.forEach(row => tbody.appendChild(row));
        }
    </script>
</body>
</html>