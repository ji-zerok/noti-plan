<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ì¡°ì§ë³„ ë¬¼ëŸ‰ ì„¤ì •</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>ê´‘ê³ ì„± ì•Œë¦¼ ë¬¼ëŸ‰ ê´€ë¦¬</h1>
            <ul class="nav-menu">
                <li><a href="/admin" class="active">ê´€ë¦¬ì</a></li>
                <li><a href="/request">ìº í˜ì¸ì‹ ì²­</a></li>
                <li><a href="/calendar">í˜„í™©ë³´ê¸°</a></li>
                <li><a href="/admin/logout">ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="admin-tabs">
            <button class="tab-btn active" data-tab="quota">ë¬¼ëŸ‰ ì„¤ì •</button>
            <button class="tab-btn" data-tab="manage">ì¡°ì§/ì„œë¹„ìŠ¤ ê´€ë¦¬</button>
        </div>

        <!-- ë¬¼ëŸ‰ ì„¤ì • íƒ­ -->
        <div id="quotaTab" class="tab-content active">
            <h3>ì¡°ì§ë³„ ì›”ê°„ ë¬¼ëŸ‰ ì„¤ì •</h3>

        <div class="form-card">
            <form id="quotaForm">
                <div class="form-group">
                    <label for="organization">ì¡°ì§</label>
                    <select id="organization" required>
                        <option value="">ì¡°ì§ ì„ íƒ</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}">{{ org.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="channel">ë°œì†¡ ì±„ë„</label>
                    <select id="channel" required>
                        <option value="naver">ë„¤ì´ë²„ì•±</option>
                        <option value="payco">í˜ì´ì•±</option>
                        <option value="talktalk">í†¡í†¡</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="yearMonth">ì—°ì›”</label>
                    <input type="month" id="yearMonth" required>
                </div>

                <div class="form-group">
                    <label for="totalQuota">ì´ ë¬¼ëŸ‰</label>
                    <input type="text" id="totalQuotaDisplay" placeholder="ì˜ˆ: 10ë§Œ" required>
                    <input type="hidden" id="totalQuota">
                    <div class="quantity-display">
                        <span id="quotaRealValue">0ê±´</span>
                    </div>
                    <small class="help-text">ì˜ˆì‹œ: 1ì²œ(1,000) / 5ë§Œ(50,000) / 100ë§Œ(1,000,000)</small>
                </div>

                <button type="submit" class="btn btn-primary">ë¬¼ëŸ‰ ì„¤ì •</button>
            </form>
        </div>

            <div class="quota-list">
                <h3>ì „ì²´ ë“±ë¡ëœ ë¬¼ëŸ‰ ëª©ë¡</h3>

                <div class="filter-section">
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex: 1;">
                            <label for="filterYearMonth">ì—°ì›” í•„í„°</label>
                            <input type="month" id="filterYearMonth">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="filterChannel">ì±„ë„ í•„í„°</label>
                            <select id="filterChannel">
                                <option value="">ì „ì²´</option>
                                <option value="naver">ë„¤ì´ë²„ì•±</option>
                                <option value="payco">í˜ì´ì•±</option>
                                <option value="talktalk">í†¡í†¡</option>
                            </select>
                        </div>
                        <button type="button" id="searchQuotaBtn" class="btn btn-primary">ì¡°íšŒí•˜ê¸°</button>
                    </div>
                </div>

                <hr style="margin: 2rem 0; border: none; border-top: 2px solid #dee2e6;">

                <div class="copy-section">
                    <h4>ğŸ“‹ ë¬¼ëŸ‰ ë³µì‚¬í•˜ê¸°</h4>
                    <p class="help-text">íŠ¹ì • ì›”ì˜ ëª¨ë“  ì¡°ì§ ë¬¼ëŸ‰ì„ ë‹¤ë¥¸ ì›”ë¡œ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <div class="copy-form">
                        <div class="form-group">
                            <label for="copySourceMonth">ë³µì‚¬í•  ì›ë³¸ ì›”</label>
                            <input type="month" id="copySourceMonth" required>
                        </div>
                        <div class="copy-arrow">â†’</div>
                        <div class="form-group">
                            <label for="copyTargetMonth">ë³µì‚¬ë  ëŒ€ìƒ ì›”</label>
                            <input type="month" id="copyTargetMonth" required>
                        </div>
                        <button type="button" id="copyQuotaBtn" class="btn btn-primary">ë³µì‚¬í•˜ê¸°</button>
                    </div>
                </div>

                <hr style="margin: 2rem 0; border: none; border-top: 2px solid #dee2e6;">

                <div id="allQuotaListContainer">
                    <p class="text-muted">ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>

        <!-- ì¡°ì§/ì„œë¹„ìŠ¤ ê´€ë¦¬ íƒ­ -->
        <div id="manageTab" class="tab-content">
            <h3>ì¡°ì§ ê´€ë¦¬</h3>
            <div class="form-card">
                <form id="orgForm">
                    <div class="form-group">
                        <label for="orgName">ì¡°ì§ëª…</label>
                        <input type="text" id="orgName" placeholder="ì˜ˆ: ëŒ€ì¶œ" required>
                    </div>
                    <button type="submit" class="btn btn-primary">ì¡°ì§ ì¶”ê°€</button>
                </form>
            </div>

            <h3 style="margin-top: 2rem;">ì„œë¹„ìŠ¤ ê´€ë¦¬</h3>
            <div class="form-card">
                <form id="serviceForm">
                    <div class="form-group">
                        <label for="serviceOrg">ì¡°ì§</label>
                        <select id="serviceOrg" required>
                            <option value="">ì¡°ì§ ì„ íƒ</option>
                            {% for org in organizations %}
                            <option value="{{ org.id }}">{{ org.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="serviceName">ì„œë¹„ìŠ¤ëª…</label>
                        <input type="text" id="serviceName" placeholder="ì˜ˆ: ì‹ ìš©ëŒ€ì¶œ" required>
                    </div>
                    <div class="form-group">
                        <label for="managerName">ë‹´ë‹¹ìëª…</label>
                        <input type="text" id="managerName" placeholder="ì˜ˆ: í™ê¸¸ë™">
                    </div>
                    <button type="submit" class="btn btn-primary">ì„œë¹„ìŠ¤ ì¶”ê°€</button>
                </form>
            </div>

            <h3 style="margin-top: 2rem;">ë“±ë¡ëœ ì¡°ì§ ëª©ë¡</h3>
            <div class="form-card">
                <div id="orgListContainer">
                    <p class="text-muted">ë¡œë”© ì¤‘...</p>
                </div>
            </div>

            <h3 style="margin-top: 2rem;">ë“±ë¡ëœ ì„œë¹„ìŠ¤ ëª©ë¡</h3>
            <div class="form-card">
                <div id="serviceListContainer">
                    <p class="text-muted">ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('quotaForm');
        const orgSelect = document.getElementById('organization');
        const channelSelect = document.getElementById('channel');
        const yearMonthInput = document.getElementById('yearMonth');
        const quotaDisplayInput = document.getElementById('totalQuotaDisplay');
        const quotaHiddenInput = document.getElementById('totalQuota');
        const quotaRealValue = document.getElementById('quotaRealValue');

        // í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ ë‹¤ìŒ ë‹¬ë¡œ ê¸°ë³¸ê°’ ì„¤ì •
        const today = new Date();
        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        yearMonthInput.value = nextMonth.toISOString().slice(0, 7);

        // ë¬¼ëŸ‰ ì…ë ¥ ë³€í™˜ í•¨ìˆ˜
        function parseKoreanNumber(input) {
            if (!input) return 0;

            // ì‰¼í‘œ ì œê±°
            input = input.replace(/,/g, '');

            // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš°
            if (/^\d+$/.test(input)) {
                return parseInt(input);
            }

            // í•œê¸€ ë‹¨ìœ„ ì²˜ë¦¬
            let result = 0;

            // ë§Œ ë‹¨ìœ„ ì²˜ë¦¬
            const manMatch = input.match(/(\d+(?:\.\d+)?)\s*ë§Œ/);
            if (manMatch) {
                result += parseFloat(manMatch[1]) * 10000;
            }

            // ì²œ ë‹¨ìœ„ ì²˜ë¦¬
            const cheonMatch = input.match(/(\d+(?:\.\d+)?)\s*ì²œ/);
            if (cheonMatch) {
                result += parseFloat(cheonMatch[1]) * 1000;
            }

            // ë°± ë‹¨ìœ„ ì²˜ë¦¬
            const baekMatch = input.match(/(\d+(?:\.\d+)?)\s*ë°±/);
            if (baekMatch) {
                result += parseFloat(baekMatch[1]) * 100;
            }

            return Math.floor(result);
        }

        // ì‹¤ì‹œê°„ ë³€í™˜ í‘œì‹œ
        quotaDisplayInput.addEventListener('input', () => {
            const value = parseKoreanNumber(quotaDisplayInput.value);
            quotaHiddenInput.value = value;
            quotaRealValue.textContent = value.toLocaleString() + 'ê±´';
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const quota = parseInt(quotaHiddenInput.value);

            if (quota < 100 || quota > 10000000) {
                alert('ë¬¼ëŸ‰ì€ 100ê±´ ì´ìƒ 1,000ë§Œê±´ ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const data = {
                organization_id: parseInt(orgSelect.value),
                channel: channelSelect.value,
                year_month: yearMonthInput.value,
                total_quota: quota
            };

            try {
                const response = await fetch('/api/quota', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    quotaDisplayInput.value = '';
                    quotaHiddenInput.value = '';
                    quotaRealValue.textContent = '0ê±´';
                    loadQuota(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ì˜¤ë¥˜: ' + result.message);
                }
            } catch (error) {
                alert('ë¬¼ëŸ‰ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        });

        // ì¡°ì§ ë˜ëŠ” ì—°ì›” ë³€ê²½ ì‹œ ì„¤ì •ëœ ë¬¼ëŸ‰ ì¡°íšŒ
        async function loadQuota() {
            if (!orgSelect.value || !yearMonthInput.value) return;

            try {
                const response = await fetch(`/api/quota/${orgSelect.value}/${yearMonthInput.value}`);
                const data = await response.json();

                const container = document.getElementById('quotaListContainer');
                if (data.total_quota > 0) {
                    container.innerHTML = `
                        <div class="quota-item">
                            <strong>${orgSelect.options[orgSelect.selectedIndex].text}</strong>
                            <span>${yearMonthInput.value}</span>
                            <span class="quota-value">${data.total_quota.toLocaleString()}ê±´</span>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p class="text-muted">ì„¤ì •ëœ ë¬¼ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } catch (error) {
                console.error('ë¬¼ëŸ‰ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        orgSelect.addEventListener('change', loadQuota);
        yearMonthInput.addEventListener('change', loadQuota);

        // ì „ì²´ ë¬¼ëŸ‰ ëª©ë¡ ë¡œë“œ
        const filterYearMonthInput = document.getElementById('filterYearMonth');
        const filterChannelSelect = document.getElementById('filterChannel');
        const searchQuotaBtn = document.getElementById('searchQuotaBtn');
        const allQuotaListContainer = document.getElementById('allQuotaListContainer');

        // ê¸°ë³¸ê°’ ì„¤ì • (ë‹¤ìŒ ë‹¬)
        filterYearMonthInput.value = nextMonth.toISOString().slice(0, 7);

        // ì´ˆê¸° ë¡œë“œ ë©”ì‹œì§€
        allQuotaListContainer.innerHTML = '<p class="text-muted">ì¡°íšŒí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>';

        // ì±„ë„ëª… ë§¤í•‘
        const channelNames = {
            'naver': 'ë„¤ì´ë²„ì•±',
            'payco': 'í˜ì´ì•±',
            'talktalk': 'í†¡í†¡'
        };

        async function loadAllQuotas() {
            const yearMonth = filterYearMonthInput.value;
            const channel = filterChannelSelect.value;

            try {
                let url = '/api/quotas?';
                if (yearMonth) url += `year_month=${yearMonth}&`;
                if (channel) url += `channel=${channel}&`;

                const response = await fetch(url);
                const quotas = await response.json();

                if (quotas.length === 0) {
                    allQuotaListContainer.innerHTML = '<p class="text-muted">ë“±ë¡ëœ ë¬¼ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                let html = '<table class="quota-table sortable"><thead><tr>';
                html += '<th class="sortable-header" data-sort-type="text">ì¡°ì§ <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">ì±„ë„ <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">ì—°ì›” <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="number">ì´ ë¬¼ëŸ‰ <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">ë“±ë¡ì¼ì‹œ <span class="sort-arrow"></span></th>';
                html += '<th>ì‘ì—…</th>';
                html += '</tr></thead><tbody>';

                quotas.forEach(quota => {
                    html += '<tr>';
                    html += `<td><strong>${quota.organization_name}</strong></td>`;
                    html += `<td><span class="channel-badge channel-${quota.channel}">${channelNames[quota.channel]}</span></td>`;
                    html += `<td>${quota.year_month}</td>`;
                    html += `<td class="quota-value">${quota.total_quota.toLocaleString()}ê±´</td>`;
                    html += `<td>${quota.created_at}</td>`;
                    html += `<td class="action-buttons">`;
                    html += `<button class="btn-edit" onclick="editQuota(${quota.id}, '${quota.organization_name}', '${quota.channel}', '${quota.year_month}', ${quota.total_quota})">ìˆ˜ì •</button>`;
                    html += `<button class="btn-delete" onclick="deleteQuota(${quota.id}, '${quota.organization_name}', '${quota.channel}', '${quota.year_month}')">ì‚­ì œ</button>`;
                    html += `</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                allQuotaListContainer.innerHTML = html;
                makeSortable();
            } catch (error) {
                console.error('ë¬¼ëŸ‰ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                allQuotaListContainer.innerHTML = '<p class="text-muted">ë¬¼ëŸ‰ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ì¡°íšŒí•˜ê¸° ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ë¡œë“œ
        searchQuotaBtn.addEventListener('click', loadAllQuotas);

        // ë¬¼ëŸ‰ ë³µì‚¬ ê¸°ëŠ¥
        const copySourceMonthInput = document.getElementById('copySourceMonth');
        const copyTargetMonthInput = document.getElementById('copyTargetMonth');
        const copyQuotaBtn = document.getElementById('copyQuotaBtn');

        // ê¸°ë³¸ê°’ ì„¤ì •
        const currentMonth = new Date();
        copySourceMonthInput.value = currentMonth.toISOString().slice(0, 7);
        copyTargetMonthInput.value = nextMonth.toISOString().slice(0, 7);

        copyQuotaBtn.addEventListener('click', async () => {
            const sourceMonth = copySourceMonthInput.value;
            const targetMonth = copyTargetMonthInput.value;

            if (!sourceMonth || !targetMonth) {
                alert('ì›ë³¸ ì›”ê³¼ ëŒ€ìƒ ì›”ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (sourceMonth === targetMonth) {
                alert('ì›ë³¸ ì›”ê³¼ ëŒ€ìƒ ì›”ì´ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì›ë³¸ ì›” ë¬¼ëŸ‰ ë¯¸ë¦¬ë³´ê¸°
            try {
                const previewResponse = await fetch(`/api/quotas?year_month=${sourceMonth}`);
                const sourceQuotas = await previewResponse.json();

                if (sourceQuotas.length === 0) {
                    alert('ì›ë³¸ ì›”ì— ì„¤ì •ëœ ë¬¼ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                let previewText = `${sourceMonth} â†’ ${targetMonth}\n\n`;
                previewText += `ë³µì‚¬ë  ì¡°ì§ (${sourceQuotas.length}ê°œ):\n`;
                sourceQuotas.forEach(quota => {
                    previewText += `- ${quota.organization_name}: ${quota.total_quota.toLocaleString()}ê±´\n`;
                });
                previewText += `\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

                if (!confirm(previewText)) {
                    return;
                }

                // ë³µì‚¬ ì‹¤í–‰
                const response = await fetch('/api/quotas/copy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        source_year_month: sourceMonth,
                        target_year_month: targetMonth
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    filterYearMonthInput.value = targetMonth;
                    loadAllQuotas();
                } else {
                    alert('ì˜¤ë¥˜: ' + result.message);
                }
            } catch (error) {
                alert('ë¬¼ëŸ‰ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        });

        // ë¬¼ëŸ‰ ìˆ˜ì •
        window.editQuota = async function(quotaId, orgName, channel, yearMonth, currentQuota) {
            const channelName = channelNames[channel];
            const input = prompt(`${orgName} - ${channelName} (${yearMonth}) ë¬¼ëŸ‰ ìˆ˜ì •\n\nì˜ˆ: 10ë§Œ, 50ë§Œ, 100ë§Œ ë“±ìœ¼ë¡œ ì…ë ¥`, '');

            if (!input) return;

            const newQuota = parseKoreanNumber(input);

            if (newQuota < 100 || newQuota > 10000000) {
                alert('ë¬¼ëŸ‰ì€ 100ê±´ ì´ìƒ 1,000ë§Œê±´ ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm(`${orgName} - ${channelName} (${yearMonth}) ë¬¼ëŸ‰ì„\n${currentQuota.toLocaleString()}ê±´ â†’ ${newQuota.toLocaleString()}ê±´\nìœ¼ë¡œ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/quota/${quotaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ total_quota: newQuota })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadAllQuotas();
                } else {
                    alert('ì˜¤ë¥˜: ' + result.message);
                }
            } catch (error) {
                alert('ë¬¼ëŸ‰ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        };

        // ë¬¼ëŸ‰ ì‚­ì œ
        window.deleteQuota = async function(quotaId, orgName, channel, yearMonth) {
            const channelName = channelNames[channel];
            if (!confirm(`${orgName} - ${channelName} (${yearMonth}) ë¬¼ëŸ‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì‚­ì œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/quota/${quotaId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadAllQuotas();
                } else {
                    alert('ì˜¤ë¥˜: ' + result.message);
                }
            } catch (error) {
                alert('ë¬¼ëŸ‰ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        };

        // íƒ­ ì „í™˜
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;

                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // ì¡°ì§ ì¶”ê°€
        const orgForm = document.getElementById('orgForm');
        orgForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('orgName').value;

            try {
                const response = await fetch('/api/organization', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    document.getElementById('orgName').value = '';

                    // ë“œë¡­ë‹¤ìš´ì— ìƒˆ ì¡°ì§ ì¶”ê°€ (ìƒˆë¡œê³ ì¹¨ ì—†ì´)
                    const newOption = document.createElement('option');
                    newOption.value = result.id;
                    newOption.textContent = name;
                    orgSelect.appendChild(newOption);

                    const serviceOrgSelect = document.getElementById('serviceOrg');
                    const newOption2 = document.createElement('option');
                    newOption2.value = result.id;
                    newOption2.textContent = name;
                    serviceOrgSelect.appendChild(newOption2);

                    loadOrgList();
                } else {
                    alert('ì˜¤ë¥˜: ' + result.message);
                }
            } catch (error) {
                alert('ì¡°ì§ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        });

        // ì„œë¹„ìŠ¤ ì¶”ê°€
        const serviceForm = document.getElementById('serviceForm');
        serviceForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                organization_id: parseInt(document.getElementById('serviceOrg').value),
                name: document.getElementById('serviceName').value,
                manager_name: document.getElementById('managerName').value
            };

            try {
                const response = await fetch('/api/service', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    serviceForm.reset();
                    loadOrgList();
                    loadServiceList();
                } else {
                    alert('ì˜¤ë¥˜: ' + result.message);
                }
            } catch (error) {
                alert('ì„œë¹„ìŠ¤ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        });

        // ì¡°ì§ ëª©ë¡ ë¡œë“œ
        async function loadOrgList() {
            try {
                const response = await fetch('/api/organizations');
                const orgs = await response.json();

                const container = document.getElementById('orgListContainer');
                if (orgs.length === 0) {
                    container.innerHTML = '<p class="text-muted">ë“±ë¡ëœ ì¡°ì§ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                let html = '<table class="quota-table sortable"><thead><tr>';
                html += '<th class="sortable-header" data-sort-type="text">ì¡°ì§ëª… <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">ë“±ë¡ì¼ì‹œ <span class="sort-arrow"></span></th>';
                html += '<th>ê´€ë¦¬</th>';
                html += '</tr></thead><tbody>';

                orgs.forEach(org => {
                    html += `<tr id="org-row-${org.id}">`;
                    html += `<td>`;
                    html += `<span id="org-name-${org.id}" class="editable-text">${org.name}</span>`;
                    html += `<input type="text" id="org-input-${org.id}" class="edit-input" value="${org.name}" style="display: none;">`;
                    html += `</td>`;
                    html += `<td>${org.created_at}</td>`;
                    html += `<td><div class="action-buttons">`;
                    html += `<button class="btn-edit" id="org-edit-btn-${org.id}" onclick="startEditOrg(${org.id})">ìˆ˜ì •</button>`;
                    html += `<button class="btn-delete" onclick="deleteOrg(${org.id}, '${org.name.replace(/'/g, "\\'")}')">ì‚­ì œ</button>`;
                    html += `<button class="btn-primary" id="org-save-btn-${org.id}" onclick="saveOrg(${org.id})" style="display: none;">ì €ì¥</button>`;
                    html += `<button class="btn-secondary" id="org-cancel-btn-${org.id}" onclick="cancelEditOrg(${org.id}, '${org.name.replace(/'/g, "\\'")}')\" style="display: none;">ì·¨ì†Œ</button>`;
                    html += `</div></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
                makeSortable();
            } catch (error) {
                console.error('ì¡°ì§ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì„œë¹„ìŠ¤ ëª©ë¡ ë¡œë“œ
        async function loadServiceList() {
            try {
                const response = await fetch('/api/services');
                const services = await response.json();

                const container = document.getElementById('serviceListContainer');
                if (services.length === 0) {
                    container.innerHTML = '<p class="text-muted">ë“±ë¡ëœ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                let html = '<table class="quota-table sortable"><thead><tr>';
                html += '<th class="sortable-header" data-sort-type="text">ì¡°ì§ <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">ì„œë¹„ìŠ¤ëª… <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">ë‹´ë‹¹ì <span class="sort-arrow"></span></th>';
                html += '<th class="sortable-header" data-sort-type="text">ë“±ë¡ì¼ì‹œ <span class="sort-arrow"></span></th>';
                html += '<th>ê´€ë¦¬</th>';
                html += '</tr></thead><tbody>';

                services.forEach(service => {
                    html += `<tr id="service-row-${service.id}" data-org-id="${service.organization_id}">`;
                    html += `<td><strong>${service.organization_name}</strong></td>`;
                    html += `<td>`;
                    html += `<span id="service-name-${service.id}" class="editable-text">${service.name}</span>`;
                    html += `<input type="text" id="service-name-input-${service.id}" class="edit-input" value="${service.name}" style="display: none;">`;
                    html += `</td>`;
                    html += `<td>`;
                    html += `<span id="service-manager-${service.id}" class="editable-text">${service.manager_name || '-'}</span>`;
                    html += `<input type="text" id="service-manager-input-${service.id}" class="edit-input" value="${service.manager_name || ''}" style="display: none;">`;
                    html += `</td>`;
                    html += `<td>${service.created_at}</td>`;
                    html += `<td><div class="action-buttons">`;
                    html += `<button class="btn-edit" id="service-edit-btn-${service.id}" onclick="startEditService(${service.id})">ìˆ˜ì •</button>`;
                    html += `<button class="btn-delete" onclick="deleteService(${service.id}, '${service.name.replace(/'/g, "\\'")}')">ì‚­ì œ</button>`;
                    html += `<button class="btn-primary" id="service-save-btn-${service.id}" onclick="saveService(${service.id})" style="display: none;">ì €ì¥</button>`;
                    html += `<button class="btn-secondary" id="service-cancel-btn-${service.id}" onclick="cancelEditService(${service.id}, '${service.name.replace(/'/g, "\\'")}', '${(service.manager_name || '').replace(/'/g, "\\'")}')\" style="display: none;">ì·¨ì†Œ</button>`;
                    html += `</div></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
                makeSortable();
            } catch (error) {
                console.error('ì„œë¹„ìŠ¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì¡°ì§ ìˆ˜ì • - ì¸ë¼ì¸ í¸ì§‘ ì‹œì‘
        window.startEditOrg = function(orgId) {
            document.getElementById(`org-name-${orgId}`).style.display = 'none';
            document.getElementById(`org-input-${orgId}`).style.display = 'inline-block';
            document.getElementById(`org-edit-btn-${orgId}`).style.display = 'none';
            document.getElementById(`org-save-btn-${orgId}`).style.display = 'inline-block';
            document.getElementById(`org-cancel-btn-${orgId}`).style.display = 'inline-block';
            document.getElementById(`org-input-${orgId}`).focus();
        };

        // ì¡°ì§ ìˆ˜ì • ì·¨ì†Œ
        window.cancelEditOrg = function(orgId, originalName) {
            document.getElementById(`org-input-${orgId}`).value = originalName;
            document.getElementById(`org-name-${orgId}`).style.display = 'inline';
            document.getElementById(`org-input-${orgId}`).style.display = 'none';
            document.getElementById(`org-edit-btn-${orgId}`).style.display = 'inline-block';
            document.getElementById(`org-save-btn-${orgId}`).style.display = 'none';
            document.getElementById(`org-cancel-btn-${orgId}`).style.display = 'none';
        };

        // ì¡°ì§ ì €ì¥
        window.saveOrg = async function(orgId) {
            const newName = document.getElementById(`org-input-${orgId}`).value.trim();
            if (!newName) {
                alert('ì¡°ì§ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`/api/organization/${orgId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message + '\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëª¨ë“  ì¡°ì§ëª…ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.');

                    // í™”ë©´ ì „ì²´ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëª¨ë“  ì¡°ì§ëª… ë™ê¸°í™”
                    location.reload();
                } else {
                    alert('ì˜¤ë¥˜: ' + result.message);
                }
            } catch (error) {
                alert('ì¡°ì§ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        };

        // ì„œë¹„ìŠ¤ ìˆ˜ì • - ì¸ë¼ì¸ í¸ì§‘ ì‹œì‘
        window.startEditService = function(serviceId) {
            document.getElementById(`service-name-${serviceId}`).style.display = 'none';
            document.getElementById(`service-name-input-${serviceId}`).style.display = 'inline-block';
            document.getElementById(`service-manager-${serviceId}`).style.display = 'none';
            document.getElementById(`service-manager-input-${serviceId}`).style.display = 'inline-block';
            document.getElementById(`service-edit-btn-${serviceId}`).style.display = 'none';
            document.getElementById(`service-save-btn-${serviceId}`).style.display = 'inline-block';
            document.getElementById(`service-cancel-btn-${serviceId}`).style.display = 'inline-block';
            document.getElementById(`service-name-input-${serviceId}`).focus();
        };

        // ì„œë¹„ìŠ¤ ìˆ˜ì • ì·¨ì†Œ
        window.cancelEditService = function(serviceId, originalName, originalManager) {
            document.getElementById(`service-name-input-${serviceId}`).value = originalName;
            document.getElementById(`service-manager-input-${serviceId}`).value = originalManager;
            document.getElementById(`service-name-${serviceId}`).style.display = 'inline';
            document.getElementById(`service-name-input-${serviceId}`).style.display = 'none';
            document.getElementById(`service-manager-${serviceId}`).style.display = 'inline';
            document.getElementById(`service-manager-input-${serviceId}`).style.display = 'none';
            document.getElementById(`service-edit-btn-${serviceId}`).style.display = 'inline-block';
            document.getElementById(`service-save-btn-${serviceId}`).style.display = 'none';
            document.getElementById(`service-cancel-btn-${serviceId}`).style.display = 'none';
        };

        // ì„œë¹„ìŠ¤ ì €ì¥
        window.saveService = async function(serviceId) {
            const newName = document.getElementById(`service-name-input-${serviceId}`).value.trim();
            const newManager = document.getElementById(`service-manager-input-${serviceId}`).value.trim();

            if (!newName) {
                alert('ì„œë¹„ìŠ¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            // data-org-id ì†ì„±ì—ì„œ organization_id ê°€ì ¸ì˜¤ê¸°
            const row = document.getElementById(`service-row-${serviceId}`);
            const orgId = row.getAttribute('data-org-id');

            console.log('Saving service:', {serviceId, newName, newManager, orgId}); // ë””ë²„ê·¸ìš©

            try {
                const response = await fetch(`/api/service/${serviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: newName,
                        organization_id: parseInt(orgId),
                        manager_name: newManager
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);

                    // í™”ë©´ ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨ ì—†ì´)
                    document.getElementById(`service-name-${serviceId}`).textContent = newName;
                    document.getElementById(`service-manager-${serviceId}`).textContent = newManager || '-';

                    // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
                    document.getElementById(`service-name-${serviceId}`).style.display = 'inline';
                    document.getElementById(`service-name-input-${serviceId}`).style.display = 'none';
                    document.getElementById(`service-manager-${serviceId}`).style.display = 'inline';
                    document.getElementById(`service-manager-input-${serviceId}`).style.display = 'none';
                    document.getElementById(`service-edit-btn-${serviceId}`).style.display = 'inline-block';
                    document.getElementById(`service-save-btn-${serviceId}`).style.display = 'none';
                    document.getElementById(`service-cancel-btn-${serviceId}`).style.display = 'none';
                } else {
                    alert('ì˜¤ë¥˜: ' + result.message);
                }
            } catch (error) {
                alert('ì„œë¹„ìŠ¤ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        };

        // ì¡°ì§ ì‚­ì œ
        window.deleteOrg = async function(orgId, orgName) {
            if (!confirm(`"${orgName}" ì¡°ì§ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì¡°ì§ì— ì„œë¹„ìŠ¤ë‚˜ ë¬¼ëŸ‰ ì •ë³´ê°€ ìˆìœ¼ë©´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/organization/${orgId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadOrgList();
                } else {
                    alert('ì˜¤ë¥˜: ' + result.message);
                }
            } catch (error) {
                alert('ì¡°ì§ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        };

        // ì„œë¹„ìŠ¤ ì‚­ì œ
        window.deleteService = async function(serviceId, serviceName) {
            if (!confirm(`"${serviceName}" ì„œë¹„ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì„œë¹„ìŠ¤ì— ìº í˜ì¸ ì‹ ì²­ì´ ìˆìœ¼ë©´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/service/${serviceId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadServiceList();
                } else {
                    alert('ì˜¤ë¥˜: ' + result.message);
                }
            } catch (error) {
                alert('ì„œë¹„ìŠ¤ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        };

        // íƒ­ ì „í™˜ ì‹œ ëª©ë¡ ë¡œë“œ
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                if (tabName === 'manage') {
                    loadOrgList();
                    loadServiceList();
                }
            });
        });

        // í…Œì´ë¸” ì •ë ¬ ê¸°ëŠ¥
        function makeSortable() {
            const tables = document.querySelectorAll('.sortable');
            tables.forEach(table => {
                const headers = table.querySelectorAll('.sortable-header');
                headers.forEach((header, index) => {
                    header.style.cursor = 'pointer';
                    header.addEventListener('click', () => {
                        sortTable(table, index, header.getAttribute('data-sort-type'));
                    });
                });
            });
        }

        function sortTable(table, columnIndex, sortType) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const header = table.querySelectorAll('.sortable-header')[columnIndex];
            const allHeaders = table.querySelectorAll('.sortable-header');

            // í˜„ì¬ ì •ë ¬ ë°©í–¥ í™•ì¸
            const isAscending = header.classList.contains('sort-asc');

            // ëª¨ë“  í—¤ë”ì˜ ì •ë ¬ í‘œì‹œ ì œê±°
            allHeaders.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
                const arrow = h.querySelector('.sort-arrow');
                if (arrow) arrow.textContent = '';
            });

            // ìƒˆë¡œìš´ ì •ë ¬ ë°©í–¥ ì„¤ì •
            const ascending = !isAscending;
            header.classList.add(ascending ? 'sort-asc' : 'sort-desc');
            const arrow = header.querySelector('.sort-arrow');
            if (arrow) arrow.textContent = ascending ? ' â–²' : ' â–¼';

            // í–‰ ì •ë ¬
            rows.sort((a, b) => {
                const aCell = a.cells[columnIndex];
                const bCell = b.cells[columnIndex];

                let aValue = aCell.textContent.trim();
                let bValue = bCell.textContent.trim();

                if (sortType === 'number') {
                    // ìˆ«ìì™€ ì‰¼í‘œ ì œê±°
                    aValue = parseInt(aValue.replace(/[^0-9]/g, '')) || 0;
                    bValue = parseInt(bValue.replace(/[^0-9]/g, '')) || 0;
                    return ascending ? aValue - bValue : bValue - aValue;
                } else {
                    // í…ìŠ¤íŠ¸ ì •ë ¬
                    return ascending
                        ? aValue.localeCompare(bValue, 'ko')
                        : bValue.localeCompare(aValue, 'ko');
                }
            });

            // ì •ë ¬ëœ í–‰ì„ ë‹¤ì‹œ ì¶”ê°€
            rows.forEach(row => tbody.appendChild(row));
        }
    </script>
</body>
</html>